---
title: "Anthromes-12K"
author: "Nick Gauthier"
date: "6/30/2020"
output: html_document
---

# Setup


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(patchwork)
devtools::load_all()
legend_long <- image_ggplot(magick::image_read('anthromes_legend_3_vertical_v1.png'))
legend_wide <- image_ggplot(magick::image_read('anthromes_legend_3.png'))
```

Import preprocessed data.

```{r}
an12_dgg_inputs <- read_sf('an12_dgg_inputs.shp') %>% 
  rename(land_area = land_ar, pot_vill = pot_vll, region_name = regn_nm) %>%
  mutate(region_name = if_else(region_name == 'Latin America', 'Latin America and Caribbean', region_name))

an12_dgg <- read_csv('an12_dgg.csv', col_types = cols(.default = 'i')) %>%
  dplyr::select(-c(`2001AD`:`2009AD`, `2011AD`:`2016AD`)) # remove annual data 

an12_dgg_long <- an12_dgg %>% 
  left_join(st_drop_geometry(an12_dgg_inputs), by = 'id') %>% 
    left_join(biome_key, by = c('pot_veg' = 'biome_value')) %>% # but join to biome key
  select(-pot_vill, -pot_veg) %>%
  pivot_longer(-c(id, land_area, biome, region_name), names_to = 'time_step', values_to = 'anthrome') 

total_land_area <- sum(an12_dgg_inputs$land_area)

#contemp vars doesn't need to be an sf object here?
contemp_vars <- read_sf('contemp_vars.shp') %>%
  mutate(pa = pa_km2 >= land_ar, ind = ind_cnt >= land_ar, kba = kba_km2 >= land_ar, 
         pa50 = pa_km2 >= (0.5 * land_ar), ind50 = ind_cnt >= (0.5 * land_ar), 
         kba50 = kba_km2 >= (0.5 * land_ar), v_rich = round(v_rich), 
         v_thr = round(v_thr), hfp_max = round(hfp_max))
```

# Analysis
## Anthrome Trajectory Summaries

Summary of of global land area for each anthrome, and broken down by region and biome.
```{r, cache = TRUE}
global_summary <- anthrome_trajectory(an12_dgg_long)
regional_summary <- anthrome_trajectory(an12_dgg_long, by = region_name)
biome_summary <- anthrome_trajectory(an12_dgg_long, by = biome)
```

Do the same thing for conservation and biodiversity variables. Note the distinction between the filtered variables and the summed ones which makes the preprocessing more complex.
```{r, cache = TRUE}
ind_summary <- contemp_vars %>%
  select(id, ind_cnt) %>%
  rename(land_area = ind_cnt) %>%
  st_drop_geometry() %>%
  remove_missing() %>%
  left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'anthrome') %>%
  anthrome_trajectory() %>%
  mutate(var = 'Indigenous Lands')

pa_summary <- contemp_vars %>%
  select(id, pa_km2) %>%
    rename(land_area = pa_km2) %>%
  st_drop_geometry() %>%
  remove_missing() %>%
  left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'anthrome') %>%
  anthrome_trajectory() %>%
  mutate(var = 'Protected Areas')

kba_summary <- contemp_vars %>%
  select(id, kba_km2) %>%
  rename(land_area = kba_km2) %>%
  st_drop_geometry() %>%
  remove_missing() %>%
 left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'anthrome') %>%
  anthrome_trajectory() %>%
  mutate(var = 'Key Biodiversity Areas')

unused_summary <- contemp_vars %>%
  select(id, land_ar) %>%
  st_drop_geometry() %>%
  left_join(an12_dgg, by = 'id') %>% 
  filter(`2017AD` >= 50)  %>% # unused lands in 2017
  select(id, land_ar) %>%
    rename(land_area = land_ar) %>%
  remove_missing() %>%
   left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'anthrome') %>%
  anthrome_trajectory() %>%
    mutate(var = 'Cultured and Wildlands (2017)')
  
nmh3_summary <- contemp_vars %>%
  mutate(nmh3_km2 = (nmh_34 - nmh_4) * land_ar) %>%
  select(id, nmh3_km2) %>%
  st_drop_geometry() %>%
    rename(land_area = nmh3_km2) %>%
   left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'anthrome') %>%
  anthrome_trajectory() %>%
  mutate(var = 'Potential Natural (NMH)')

nmh4_summary <- contemp_vars %>%
  mutate(nmh4_km2 = nmh_4 * land_ar) %>%
  select(id, nmh4_km2) %>%
  st_drop_geometry() %>%
  rename(land_area = nmh4_km2) %>%
   left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'anthrome') %>%
  anthrome_trajectory() %>%
  mutate(var = 'Likely Natural (NMH)')

shared_3gc_summary <- contemp_vars %>%
  filter(X_3_c_4 == 2) %>%
  select(id, land_ar) %>%
  st_drop_geometry() %>%
  rename(land_area = land_ar) %>%
   left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'anthrome') %>%
  anthrome_trajectory() %>%
  mutate(var = 'Shared Lands (3GC)')

wild_3gc_summary <- contemp_vars %>%
  filter(X_3_c_4 == 3) %>%
  select(id, land_ar) %>%
  st_drop_geometry() %>%
  rename(land_area = land_ar) %>%
   left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'anthrome') %>%
  anthrome_trajectory() %>%
  mutate(var = 'Large Wild Areas (3GC)')

contemp_summary <- bind_rows(kba_summary, pa_summary,
                             ind_summary, unused_summary, 
                             nmh3_summary, nmh4_summary, 
                             shared_3gc_summary, wild_3gc_summary) %>%
  # make sure they plot in the right order
  mutate(var = factor(var, levels = c('Key Biodiversity Areas', 'Protected Areas',
                                      'Indigenous Lands', 'Cultured and Wildlands (2017)', 
                                        'Potential Natural (NMH)',  'Likely Natural (NMH)', 
                                        'Shared Lands (3GC)', 'Large Wild Areas (3GC)')))

rm(kba_summary, pa_summary, ind_summary, unused_summary, nmh3_summary, nmh4_summary, shared_3gc_summary, wild_3gc_summary)
```


Save summary files

```{r}
global_summary %>% 
  select(-period, -year) %>% 
  pivot_wider(id_cols = class, names_from = time_step, values_from = percent_land_area) %>%
  mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>%
  left_join(anthrome_key, by = 'class') %>%
  select(class, level, type, any_of(time_steps_ordered)) %>%
  write_csv('data/derived_data/an12_dgg_summary_global.csv')

region_summary %>%
  select(-period, -year) %>%
  pivot_wider(id_cols = c(class, region_name), names_from = time_step, values_from = percent_land_area) %>%
  arrange(region_name, class) %>%
  left_join(anthrome_key, by = 'class') %>%
  select(region_name, class, level, type, any_of(time_steps_ordered)) %>%
  mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>%
  write_csv('data/derived_data/an12_dgg_summary_region.csv')

biome_summary %>%
  select(-period, -year) %>%
  pivot_wider(id_cols = c(biome, class), names_from = time_step, values_from = percent_land_area) %>%
  arrange(biome, class) %>%
  left_join(anthrome_key, by = 'class') %>%
  select(biome, class, level, type, any_of(time_steps_ordered)) %>%
  mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>%
  write_csv('data/derived_data/an12_dgg_summary_biomes.csv')

contemp_summary %>%
  select(-period, -year) %>%
  pivot_wider(id_cols = c(var, class), names_from = time_step, values_from = percent_land_area) %>%
  arrange(var, class) %>%
  left_join(anthrome_key, by = 'class') %>%
  select(var, class, level, type, any_of(time_steps_ordered)) %>%
  mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>%
  write_csv('data/derived_data/an12_dgg_summary_contemp.csv')
```

## HYDE Population Curves

Get HYDE population data.
```{r}
hyde_pop <- readRDS('data/derived_data/hyde_dgg') %>%
  filter(var == 'popc') %>%
  select(-var) %>%
  pivot_longer(-ANL12_ID, names_to = 'time_step', values_to = 'population') %>%
  mutate(time_step = ordered(time_step, levels = time_steps_ordered))

hyde_pop_all <- hyde_pop %>%
  group_by(time_step) %>%
  summarise(population = sum(population)) %>%
    mutate(pop_percent = population / max(population)) %>%
  left_join(time_key, by = 'time_step') %>%
  filter(!(year %in% c(2001:2009,2011:2016))) %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades')))
  
hyde_pop_regions <- hyde_pop %>%
  left_join(st_drop_geometry(an12_dgg_inputs), by = c('ANL12_ID' = 'id')) %>%
  group_by(region_name, time_step) %>%
  summarise(population = sum(population)) %>%
  mutate(pop_percent = population / max(population)) %>%
  ungroup() %>%
  left_join(time_key, by = 'time_step') %>%
    filter(!(year %in% c(2001:2009,2011:2016))) %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades')))

hyde_pop_biomes <- hyde_pop %>%
  left_join(st_drop_geometry(an12_dgg_inputs), by = c('ANL12_ID' = 'id')) %>%
    left_join(biome_key, by = c('pot_veg' = 'biome_value')) %>%
  select(-pot_veg) %>%
  group_by(biome, time_step) %>%
  summarise(population = sum(population)) %>%
  mutate(pop_percent = population / max(population)) %>%
  ungroup() %>%
  left_join(time_key, by = 'time_step') %>%
    filter(!(year %in% c(2001:2009,2011:2016))) %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
    filter(biome != 'Ice, snow')
```


## Anthrome Legacies

Prepare a data frame for regression.
```{r}
regression_dat <- an12_dgg %>%
  pivot_longer(-id, names_to = 'time', values_to = 'anthrome') %>%
  left_join(anthrome_key) %>%
  dplyr::select(-anthrome, -level, -type) %>%
  pivot_wider(names_from = time, values_from = class) %>%
  left_join(st_drop_geometry(contemp_vars), by = 'id') %>%
  na.omit %>%
  select(id, land_ar, nmh, hfp_max:kba50, all_of(unique(c(time_steps_millennia, time_steps_centuries))), `2010AD`,`2017AD`) %>%
  rename_with(~paste0('an_', .), all_of(unique(c(time_steps_millennia, time_steps_centuries, '2010AD', '2017AD')))) %>%
  left_join(an12_dgg_inputs %>%
              select(id, region_name) %>%
              st_drop_geometry())
```


Fit a global GLM and one limited to natural areas and protected areas.

```{r, cache = TRUE}
legacy_mods <- expand_grid(time_step = unique(c(time_steps_millennia, 
                                                time_steps_centuries)),
                           predictands = c('kba50', 'v_thr', 'v_rich')) %>%
  mutate(predictors = paste0('an_', time_step),
         fam = if_else(predictands == 'kba50', 'binomial', 'poisson'),
         global_aic = pmap_dbl(list(predictands, predictors, fam), 
                        calc_aic, dat = regression_dat),
         nmh_aic = pmap_dbl(list(predictands, predictors, fam), 
                        calc_aic, dat = filter(regression_dat, nmh_34 > 0.5)),
         pa_aic = pmap_dbl(list(predictands, predictors, fam), 
                        calc_aic, dat = filter(regression_dat, pa50 == TRUE)),
          ind_aic = pmap_dbl(list(predictands, predictors, fam), 
                        calc_aic, dat = filter(regression_dat, ind50 == TRUE))) %>%
  pivot_longer(global_aic:ind_aic) %>%
  group_by(predictands, name) %>%
  mutate(aic_scaled = scales::rescale(value)) %>%
  ungroup()
```

# Figures

## Figure 1 - Global Summary

```{r, fig.width=9, fig.height=3.5}
global_plot <- global_summary %>%
  mutate(time_step = ordered(time_step, levels = time_steps_ordered)) %>%
  filter(class != 'Ice') %>%
  ggplot(aes(time_step, percent_land_area)) +
  geom_col(aes(fill = class, color = class), position = 'fill', width = .8, size = .1)+
    geom_hline(yintercept = .5, linetype = 2, color = 'black', alpha = .25) +
  geom_line(data = hyde_pop_all, aes(y = pop_percent), color = 'darkred', linetype = 1, group = 1, size = .8) +
  scale_fill_manual(values = anthrome_colors, name = 'Anthrome') +
  scale_color_manual(values = anthrome_colors, name = 'Anthrome') +
  facet_grid(~period, scales = 'free_x', space = 'free') +
  theme_classic() +
  scale_y_continuous(expand = c(0.01,0.01), labels = scales::percent_format(accuracy = 1), n.breaks = 3) +
  scale_x_discrete(breaks = c('8000BC', '0AD', '800AD', '1700AD', '1800AD', '1900AD', '2000AD'), 
                   labels = c('8000ʙᴄᴇ', '1ᴄᴇ', '800ᴄᴇ', '1700ᴄᴇ', '1800ᴄᴇ', '1900ᴄᴇ', '2000ᴄᴇ')) +
  labs(x = 'Year', y = 'Percent land area') +
  theme(legend.position = 'none', strip.text.x = element_text(hjust = 0), panel.spacing.x=unit(.1, "lines"), strip.background = element_blank(), axis.line.y = element_blank(),  axis.text=element_text(size=rel(0.7)), panel.border = element_rect(colour = "grey20", fill=NA, size = 1))

global_plot
```


## Figure 2 - Regional Summary

```{r, fig.width = 9, fig.height = 8}
region_plot <- regional_summary %>% 
  filter(!is.na(region_name)) %>%
  mutate(time_step = ordered(time_step, levels = time_steps_ordered)) %>%
  ggplot(aes(time_step, percent_land_area)) +
  geom_col(aes(fill = class, color = class), width = .8, size = .1)+
  geom_vline(xintercept = c('0AD', '1700AD'), color = 'black', alpha = .5) +
  geom_hline(yintercept = .5, linetype = 2, color = 'black', alpha = .25) +
  geom_line(data = hyde_pop_regions, aes(y = pop_percent), color = 'darkred', linetype = 1, group = 1, size = .7) +
  facet_wrap(~region_name, ncol = 2) +
  scale_fill_manual(values = anthrome_colors) +
  scale_color_manual(values = anthrome_colors) +
  theme_classic() +
  scale_y_continuous(expand = c(0.01,0.01), labels = scales::percent_format(accuracy = 1), n.breaks = 3) +
  scale_x_discrete(breaks = c('8000BC', '0AD', '800AD', '1700AD', '1800AD', '1900AD', '2000AD'), 
                   labels = c('8000ʙᴄᴇ', '1ᴄᴇ', '800ᴄᴇ', '1700ᴄᴇ', '1800ᴄᴇ', '1900ᴄᴇ', '2000ᴄᴇ')) +
  labs(x = 'Year', y = 'Percent land area') +
  theme(legend.position = 'none', strip.text.x = element_text(hjust = 0), panel.spacing.x=unit(.7, "lines"), strip.background = element_blank(), axis.line.y = element_blank(),  axis.text=element_text(size=rel(0.7)), panel.border = element_rect(colour = "grey20", fill=NA, size = 1))

fig2 <-region_plot + legend_long + plot_layout(widths =c(3,1))
fig2
```


## Figure 3 - Biome summary

```{r fig.width = 9, fig.height = 8}
biome_plot <- biome_summary %>% 
  mutate(time_step = ordered(time_step, levels = time_steps_ordered)) %>%
  filter( class != 'NODATA', class != 'Ice', biome != 'Ice, snow') %>%
  ggplot(aes(time_step, percent_land_area)) +
  geom_col(aes(fill = class, color = class), width = .8, size = .1)+
  geom_vline(xintercept = c('0AD', '1700AD'), color = 'black', alpha = .5) +
  geom_hline(yintercept = .5, linetype = 2, color = 'black', alpha = .25) +
  geom_line(data = hyde_pop_biomes, aes(y = pop_percent), color = 'darkred', linetype = 1, group = 1) +
  facet_wrap(~biome, ncol = 2, dir = 'v') +
  scale_fill_manual(values = anthrome_colors, name = 'Anthrome') +
  scale_color_manual(values = anthrome_colors, name = 'Anthrome') +
  theme_classic() +
  scale_y_continuous(expand = c(0.01,0.01), labels = scales::percent_format(accuracy = 1), n.breaks = 3) +
  scale_x_discrete(breaks = c('8000BC', '0AD', '800AD', '1700AD', '1800AD', '1900AD', '2000AD'), 
                   labels = c('8000ʙᴄᴇ', '1ᴄᴇ', '800ᴄᴇ', '1700ᴄᴇ', '1800ᴄᴇ', '1900ᴄᴇ', '2000ᴄᴇ')) +
  labs(x = 'Year', y = 'Percent land surface') +
  theme(legend.position = 'none', strip.text.x = element_text(hjust = 0), panel.spacing.x=unit(.7, "lines"), strip.background = element_blank(), axis.line.y = element_blank(),  axis.text=element_text(size=rel(0.7)), panel.border = element_rect(colour = "grey20", fill=NA, size = 1))

fig3 <- biome_plot + legend_long + plot_layout(widths = c(3, 1))
fig3
```

## Figure 4 - Contemporary Data

```{r}
contemp_plot <- contemp_summary %>%
  mutate(time_step = ordered(time_step, levels = time_steps_ordered)) %>%
  filter(class != 'NODATA', class != 'Ice') %>%
  ggplot(aes(time_step, percent_land_area)) +
  geom_col(aes(fill = class, color = class), position = 'fill', width = .8, size = .1)+
  geom_vline(xintercept = c('0AD', '1700AD'), color = 'black', alpha = .5) +
  geom_hline(yintercept = .5, linetype = 2, color = 'black', alpha = .25) +
  facet_wrap(~var, ncol = 2, dir = 'h') +
  scale_fill_manual(values = anthrome_colors, name = 'Anthrome') +
  scale_color_manual(values = anthrome_colors, name = 'Anthrome') +
  theme_classic() +
  scale_y_continuous(expand = c(0.01,0.01), labels = scales::percent_format(accuracy = 1), n.breaks = 3) +
  scale_x_discrete(breaks = c('8000BC', '0AD', '800AD', '1700AD', '1800AD', '1900AD', '2000AD'), 
                   labels = c('8000ʙᴄᴇ', '1ᴄᴇ', '800ᴄᴇ', '1700ᴄᴇ', '1800ᴄᴇ', '1900ᴄᴇ', '2000ᴄᴇ')) +
  labs(x = 'Year', y = 'Percent land surface') +
  theme(legend.position = 'none', strip.text.x = element_text(hjust = 0), panel.spacing.x=unit(1, "lines"), strip.background = element_blank(), axis.line.y = element_blank(),  axis.text=element_text(size=rel(0.7)), panel.border = element_rect(colour = "grey20", fill=NA, size = 1))

contemp_plot + legend_long + plot_layout(widths = c(3, 1))
```
 
```{r}
legacy_plot <- legacy_mods %>%
  left_join(time_key) %>%
  mutate(vars = factor(predictands, levels = rev(c('v_rich', 'v_thr', 'kba50'))),
         name = case_when(str_detect(name, 'global') ~ 'Global Lands',
                          str_detect(name, 'nmh') ~ 'Likely and Potential Natural Lands (NMH)',
                          str_detect(name, 'pa') ~ 'Protected Areas',
                          str_detect(name, 'ind') ~ 'Indigenous Lands')) %>%
   ggplot(aes(as.factor(year), vars, fill = aic_scaled), color = 'white') +
  geom_tile() +
  geom_vline(xintercept = '1', color = 'red', linetype = 2) +
  scale_fill_viridis_c(name = '', breaks = c(.05, .95), trans = 'reverse', labels = c('More informative', 'Less informative')) +
  theme_classic() +
  facet_wrap(~name, ncol = 1) +
  scale_y_discrete(labels = c('Key Biodiversity Areas', 'Threatened Species Richness', 'Species Richness')) +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1500, 2000),
                   labels = c('10000ᴄᴇ', '5000ᴄᴇ', '1ᴄᴇ', '500ᴄᴇ', '1000ᴄᴇ', '1500ᴄᴇ', '2000ᴄᴇ'))  +
  labs(x = 'Anthrome Year', y = NULL) +
  theme(strip.background = element_blank(), axis.text=element_text(size=rel(0.8)), legend.position = 'bottom')
```

```{r, fig.width=8, fig.height =9}
fig4 <- (wrap_elements(full = contemp_plot + legend_long + plot_layout(widths = c(3, 1))) / legacy_plot) + plot_layout(heights = c(1.5,1)) + plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')')

fig4
```


### Save figures

```{r}
# save vector graphics for high quality figures
# ggsave('figures/anthrome_summary_global.svg', plot = global_plot, width = 9, height = 3.5)
# ggsave('figures/anthromes_summary_region.svg', plot = addSmallLegend(region_plot) + guides(color = FALSE), height = 8, width = 9)
# ggsave('figures/anthromes_summary_biome.svg', plot = addSmallLegend(biome_plot), height = 8, width = 9)
# ggsave('figures/anthromes_legacies.svg', plot = fig4, height = 9, width = 8)

# save pngs for drafts and email
ggsave('figures/anthrome_summary_global.png', plot = global_plot, width = 9, height = 3.5, dpi = 600)
ggsave('figures/anthromes_summary_region.png', plot = fig2, height = 8, width = 9, dpi = 600)
ggsave('figures/anthromes_summary_biome.png', plot = fig3, height = 8, width = 9, dpi = 600)
ggsave('figures/anthromes_legacies.png', plot = fig4, height = 9, width = 8, dpi = 600)
```


# Other Visualizations
Other visualization and analyses not included in the main paper.

## Regional Breakdown

```{r}
regions_dat <- regression_dat %>% 
  group_nest(region_name)
```

```{r}
fit_mod1 <- function(x) {
  expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
              predictands = c('v_thr', 'v_rich')) %>%
    mutate(predictors = paste0('an_', time_step),
           aic = map2_dbl(predictands, predictors, calc_aic, fam = poisson(), dat = x))
}

fit_mod2 <- function(x) {
  expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
              predictands = c('kba50')) %>%
    mutate(predictors = paste0('an_', time_step),
           aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(), dat = x))
}
```


```{r}
t1 <- regions_dat %>%
  mutate(mod = map(data, fit_mod1)) %>%
  select(-data)

t2 <- regions_dat %>%
  mutate(mod = map(data, fit_mod2)) %>%
  select(-data)

regions_dat2 <- bind_rows(t1, t2) %>%
  unnest(mod) %>%
  left_join(time_key)
```

```{r, fig.width = 7.2, fig.height = 8}
regions_dat2 %>%
  mutate(vars = factor(predictands, levels = rev(c('v_rich', 'v_thr', 'kba50')))) %>%
  group_by(vars, region_name) %>%
  mutate(aic_scaled = scales::rescale(aic)) %>%
  ggplot(aes(as.factor(year), vars, fill = aic_scaled), color = 'white') +
  geom_tile() +
  geom_vline(xintercept = '1', color = 'red', linetype = 2) +
  facet_wrap(~region_name, ncol = 1) +
 scale_fill_viridis_c(name = '', breaks = c(.05, .95), trans = 'reverse', labels = c('More informative', 'Less informative')) +
  theme_classic() +
  scale_y_discrete(labels = c('Key Biodiversity Areas', 'Threatened Species Richness', 'Species Richness')) +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1500, 2000),
                   labels = c('10000ᴄᴇ', '5000ᴄᴇ', '1ᴄᴇ', '500ᴄᴇ', '1000ᴄᴇ', '1500ᴄᴇ', '2000ᴄᴇ'))  +
  labs(x = 'Anthrome Year', y = NULL) +
  theme(strip.background = element_blank(), axis.text=element_text(size=rel(0.8)), legend.position = 'bottom')
```

```{r}
ggsave('figures/anthromes_legacies_regions.png', height = 8, width = 7.2, dpi = 600)
ggsave('figures/anthromes_legacies_regions.svg', height = 8, width = 7.2)
```


## Onsets

```{r}
intensive_onset <- an12_dgg %>%
    pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
    group_by(id) %>%
    filter(anthrome <= 43) %>%
    left_join(time_key) %>%
    summarise(intensive_onset = min(year, na.rm = TRUE))

change_type <- an12_dgg %>%
    pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
      group_by(id) %>%
  summarise(intensive = any(anthrome <= 43), cultured = any(anthrome <= 54)) %>%
  left_join(intensive_onset, by = 'id') %>%
  mutate(class = case_when(intensive == TRUE & intensive_onset <= 1 ~'U0001', # fyi case when statement evaluates in order
                            intensive == TRUE & intensive_onset <= 1500 ~ 'U1500',
                            intensive == TRUE & intensive_onset <= 1850 ~ 'U1850',
                            intensive == TRUE & intensive_onset <= 1950 ~ 'U1950',
                            intensive == TRUE ~ 'RECNT',
                            cultured == TRUE ~ 'SEMI',
                            TRUE  ~ 'NEVR')) %>%
  left_join(an12_dgg_inputs, ., by = 'id') %>%
  mutate(class_biome = if_else(pot_veg <= 8, paste0('W_', class), paste('N_', class))) %>%
  select(id, land_area, class, class_biome, geometry)
```

```{r}
change_type %>% count(class) %>% mutate(n = n / sum(n) * 100)
```

```{r}
change_type %>% pull(land_area) %>% sum
```

```{r}
change_type %>% st_drop_geometry %>% count(class, wt =  land_area, name = 'area') %>% 
  mutate(percent = area / sum(area) * 100)%>%  write_csv('onsets_simple_area.csv')
```

```{r}
change_type %>% st_drop_geometry %>%  count(class_biome, wt =  land_area, name = 'area') %>% 
  mutate(percent = area / sum(area) * 100) %>% write_csv('onsets_biome_area.csv')
```


```{r}
change_type %>%
mutate(class = factor(class, levels = c( "NEVR" , "SEMI" , "U0001" ,"U1500","U1850" ,"U1950" ,"RECNT")))  %>%
  st_as_sf() %>%
 #    st_crop(st_bbox(c(xmin = 10, xmax = 50, ymin = 20, ymax = 50))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = class, geometry = geometry), color = NA, lwd = .1)+
  scale_fill_viridis_d() +
  theme_bw() +
  coord_sf(crs = st_crs("+proj=eck4"))
```

```{r}
write_csv(change_type %>% st_drop_geometry(), 'change_type.csv')
```


```{r}
change_type %>%
  group_by(change) %>%
  count() %>%
  ungroup() %>%
  mutate(test = n / sum(n) * 100)
```

## always uninhabited
does this end up being the same as the above analysis?
```{r}
an12_dgg %>% 
  pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
  filter(anthrome == 61) %>%
  group_by(id) %>%
  count %>%
  filter(n == 60) %>%
  left_join(st_drop_geometry(an12_dgg_inputs), by = 'id') %>%
  pull(land_area) %>%
  sum %>%
  `/`(total_land_area)%>%
  `*`(100)

an12_dgg %>% 
  pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
  filter(anthrome == 62) %>%
  group_by(id) %>%
  count %>%
  filter(n == 60) %>%
  left_join(st_drop_geometry(an12_dgg_inputs), by = 'id') %>%
  pull(land_area) %>%
  sum %>%
  `/`(total_land_area)%>%
  `*`(100)

an12_dgg %>% 
  pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
  filter(anthrome == 63) %>%
  group_by(id) %>%
  count %>%
  filter(n == 60) %>%
  left_join(st_drop_geometry(an12_dgg_inputs), by = 'id') %>%
  pull(land_area) %>%
  sum %>%
  `/`(total_land_area) %>%
  `*`(100)
######################

an12_dgg_inputs %>%
  st_drop_geometry() %>%
  mutate(woodland = if_else(pot_veg <= 8, 'woodland', 'bare')) %>%
  group_by(woodland) %>%
  count(wt = land_area, name = 'area')

an12_dgg %>% 
  pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
  filter(anthrome == 61) %>%
  group_by(id) %>%
  count %>%
  filter(n == 60) %>%
  left_join(st_drop_geometry(an12_dgg_inputs), by = 'id') %>%
  pull(land_area) %>%
  sum %>%
  `/`(55432294)%>%
  `*`(100)

an12_dgg %>% 
  pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
  filter(anthrome == 62) %>%
  group_by(id) %>%
  count %>%
  filter(n == 60) %>%
  left_join(st_drop_geometry(an12_dgg_inputs), by = 'id') %>%
  pull(land_area) %>%
  sum %>%
  `/`(76287578)%>%
  `*`(100)

```

## Cramer's V
```{r}
#cramers v test
library(rcompanion)
cramer <- summarise_all(an12_dgg[2:61], ~cramerV(an12_dgg$`2017AD`, .))[1,] %>% as.numeric

qplot(x = time_key$year[-c(59:67, 69:74)], y = cramer, geom = 'point')


test2 <- summarise_all(an12_dgg[2:61], ~cramerV(an12_dgg$`2017AD`, ., ci = TRUE))
```

## Unused lands

```{r}
hyde <- readRDS('hyde_dgg')
dgg_ids <- readRDS('dgg_ids')

hyde_crop <- hyde %>%
  dplyr::select(contains('cropland')) %>%
    mutate(id = dgg_ids) %>%
  filter(id %in% an12_dgg_inputs$id) %>%
  pivot_longer(-id) %>%
  mutate(time_step = str_remove(name, 'sum.cropland')) %>%
  select(-name) %>%
  filter(time_step %in% c(time_steps_decades, time_steps_centuries, time_steps_millennia)) %>%
  pivot_wider(names_from = time_step, values_from = value)
gc()

hyde_grazing <- hyde %>%
  dplyr::select(contains('grazing')) %>%
    mutate(id = dgg_ids) %>%
  filter(id %in% an12_dgg_inputs$id) %>%
  pivot_longer(-id)  %>%
  mutate(time_step = str_remove(name, 'sum.grazing')) %>%
  select(-name) %>%
    filter(time_step %in% c(time_steps_decades, time_steps_centuries, time_steps_millennia)) %>%
    pivot_wider(names_from = time_step, values_from = value)

gc()
hyde_urban <- hyde %>%
  dplyr::select(contains('uopp')) %>%
    mutate(id = dgg_ids) %>%
  filter(id %in% an12_dgg_inputs$id) %>%
  pivot_longer(-id)  %>%
  mutate(time_step = str_remove(name, 'sum.uopp_')) %>%
  select(-name) %>%
    filter(time_step %in% c(time_steps_decades, time_steps_centuries, time_steps_millennia)) %>%
    pivot_wider(names_from = time_step, values_from = value)

gc()

hyde_unused <- bind_rows(hyde_crop, hyde_urban, hyde_grazing) %>%
  group_by(id) %>%
  summarise_all(~1 - sum(.)) # wrong! should be land_area - sum(.)
save(hyde_unused, file = 'hyde_unused')
```

```{r, fig.height = 2, fig.width = 10}
load('hyde_unused')
unused_summary <- hyde_unused %>%
    mutate(land_area = an12_dgg_inputs$land_area) %>% 
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'unused') %>% 
  mutate(unused = 1 - unused,
         unused = land_area - unused) %>% # plot this 
  left_join(pivot_longer(an12_dgg, -id, names_to = 'time_step', values_to = 'anthrome')) %>%
  count(time_step, anthrome, wt = unused, name = 'unused_area') %>%
  left_join(anthrome_key) %>%
   left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>% 
    mutate(percent_land_area = unused_area /total_land_area) %>%
  select(time_step, class, percent_land_area, period, year)

 unused_summary %>%
  mutate(time_step = ordered(time_step, levels = time_steps_ordered)) %>%
  filter(class != 'Ice') %>%
  ggplot(aes(time_step, percent_land_area)) +
  geom_col(aes(fill = class, color = class), width = .8, size = .1)+
  #  geom_hline(yintercept = .5, linetype = 2, color = 'black', alpha = .25) +
  scale_fill_manual(values = anthrome_colors, name = 'Anthrome') +
  scale_color_manual(values = anthrome_colors, name = 'Anthrome') +
  #facet_grid(~period, scales = 'free_x', space = 'free') +
  theme_classic() +
  scale_y_continuous(expand = c(0.01,0.01), labels = scales::percent_format(accuracy = 1)) +
  scale_x_discrete(breaks = c('8000BC', '0AD', '800AD', '1700AD', '1800AD', '1900AD', '2000AD'), 
                   labels = c('8000ʙᴄᴇ', '1ᴄᴇ', '800ᴄᴇ', '1700ᴄᴇ', '1800ᴄᴇ', '1900ᴄᴇ', '2000ᴄᴇ')) +
  labs(x = 'Year', y = 'Percent land area') +
  theme(legend.position = 'none', strip.text.x = element_text(hjust = 0), panel.spacing.x=unit(.1, "lines"), strip.background = element_blank(), axis.line.y = element_blank(),  axis.text=element_text(size=rel(0.7)), panel.border = element_rect(colour = "grey20", fill=NA, size = 1))
 ggsave('unused_trajectory.png', height =2, width = 10)
```


## Olson biomes

```{r}
olson_key <- tibble(olson_biome = 1:14,
       olson_name = factor(c('Tropical & Subtropical Moist Broadleaf Forests', 'Tropical & Subtropical Dry Broadleaf Forests',
                      'Tropical & Subtropical Coniferous Forests', 'Temperate Broadleaf & Mixed Forests', 'Temperate Conifer Forests', 'Boreal Forests/Taiga', 'Tropical & Subtropical Grasslands, Savannas & Shrublands', 'Temperate Grasslands, Savannas & Shrublands', 'Flooded Grasslands & Savannas', 'Montane Grasslands & Shrublands', 'Tundra', 'Mediterranean Forests, Woodlands & Scrub', 'Deserts & Xeric Shrublands', 'Mangroves'), levels = c('Tropical & Subtropical Moist Broadleaf Forests', 'Tropical & Subtropical Dry Broadleaf Forests',
                      'Tropical & Subtropical Coniferous Forests', 'Temperate Broadleaf & Mixed Forests', 'Temperate Conifer Forests', 'Boreal Forests/Taiga', 'Tropical & Subtropical Grasslands, Savannas & Shrublands', 'Temperate Grasslands, Savannas & Shrublands', 'Flooded Grasslands & Savannas', 'Montane Grasslands & Shrublands', 'Tundra', 'Mediterranean Forests, Woodlands & Scrub', 'Deserts & Xeric Shrublands', 'Mangroves')))
```

```{r}
olson_summary <- an12_dgg_long %>% 
  left_join(read_csv('tmp/olson_tmp.csv')) %>%
  filter(!(olson_biome %in% c(0, NA))) %>% # the NA's are from the land mask, but what about the 0's
  mutate(olson_biome = as.factor(olson_biome)) %>%
  anthrome_trajectory(by = olson_biome) %>%
  mutate(olson_biome = as.numeric(olson_biome)) %>%
  left_join(olson_key)
```

```{r, fig.width=9, fig.height=10}
olson_plot <- olson_summary %>%
  mutate(time_step = ordered(time_step, levels = time_steps_ordered)) %>%
  filter( class != 'NODATA') %>%
  ggplot(aes(time_step, percent_land_area)) +
  geom_col(aes(fill = class, color = class), width = .8, size = .1)+
  geom_vline(xintercept = c('0AD', '1700AD'), color = 'black', alpha = .5) +
  geom_hline(yintercept = .5, linetype = 2, color = 'black', alpha = .25) +
  facet_wrap(~olson_name, ncol = 2, dir = 'v') +
  scale_fill_manual(values = anthrome_colors, name = 'Anthrome') +
  scale_color_manual(values = anthrome_colors, name = 'Anthrome') +
  theme_classic() +
  scale_y_continuous(expand = c(0.01,0.01), labels = scales::percent_format(accuracy = 1), n.breaks = 3) +
  scale_x_discrete(breaks = c('8000BC', '0AD', '800AD', '1700AD', '1800AD', '1900AD', '2000AD'), 
                   labels = c('8000ʙᴄᴇ', '1ᴄᴇ', '800ᴄᴇ', '1700ᴄᴇ', '1800ᴄᴇ', '1900ᴄᴇ', '2000ᴄᴇ')) +
  labs(x = 'Year', y = 'Percent land surface') +
  theme(legend.position = 'none', strip.text.x = element_text(hjust = 0), panel.spacing.x=unit(.7, "lines"), strip.background = element_blank(), axis.line.y = element_blank(),  axis.text=element_text(size=rel(0.7)), panel.border = element_rect(colour = "grey20", fill=NA, size = 1))

olson_plot + legend_long + plot_layout(widths = c(3, 1))
```

```{r}
ggsave('figures/olson_biomes.png', olson_plot + legend_long + plot_layout(widths = c(3, 1))
, height = 10, width = 9, dpi = 600)
```

## 15 class pnv
```{r}
biome_key_15 <- tibble(biome_value = 1:15,
                    biome15 = factor(c('Tropical Evergreen Woodland', 
                                       'Tropical Deciduous Woodland', 
                                       'Temperate Broadleaf and Evergreen Woodland', 
                                       'Temperate Needleleaf and Evergreen Woodland', 
                                       'Temperate Deciduous Woodland', 
                                       'Boreal Evergreen Woodland', 
                                       'Boreal Deciduous Woodland', 
                                       'Mixed Forest', 
                                       'Savanna', 
                                       'Grassland and Steppe', 
                                       'Dense Shrubland', 'Open Shrubland',	'Tundra',	'Desert and Barren', 'Polar Desert, Rock, and Ice'), levels = c('Tropical Evergreen Woodland', 
                                       'Tropical Deciduous Woodland', 
                                       'Temperate Broadleaf and Evergreen Woodland', 
                                       'Temperate Needleleaf and Evergreen Woodland', 
                                       'Temperate Deciduous Woodland', 
                                       'Boreal Evergreen Woodland', 
                                       'Boreal Deciduous Woodland', 
                                       'Mixed Forest', 
                                       'Savanna', 
                                       'Grassland and Steppe', 
                                       'Dense Shrubland', 'Open Shrubland',	'Tundra',	'Desert and Barren', 'Polar Desert, Rock, and Ice'))) %>%
  left_join(biome_key)

biome15_summary <- an12_dgg_long %>%
  left_join(biome_key_15) %>%
  anthrome_trajectory(by = biome15)
```

```{r, fig.width=9, fig.height=10}
biome15_plot <- biome15_summary %>%
  mutate(time_step = ordered(time_step, levels = time_steps_ordered)) %>%
  filter( class != 'NODATA') %>%
  ggplot(aes(time_step, percent_land_area)) +
  geom_col(aes(fill = class, color = class), width = .8, size = .1)+
  geom_vline(xintercept = c('0AD', '1700AD'), color = 'black', alpha = .5) +
  geom_hline(yintercept = .5, linetype = 2, color = 'black', alpha = .25) +
  facet_wrap(~biome15, ncol = 2, dir = 'v') +
  scale_fill_manual(values = anthrome_colors, name = 'Anthrome') +
  scale_color_manual(values = anthrome_colors, name = 'Anthrome') +
  theme_classic() +
  scale_y_continuous(expand = c(0.01,0.01), labels = scales::percent_format(accuracy = 1), n.breaks = 3) +
  scale_x_discrete(breaks = c('8000BC', '0AD', '800AD', '1700AD', '1800AD', '1900AD', '2000AD'), 
                   labels = c('8000ʙᴄᴇ', '1ᴄᴇ', '800ᴄᴇ', '1700ᴄᴇ', '1800ᴄᴇ', '1900ᴄᴇ', '2000ᴄᴇ')) +
  labs(x = 'Year', y = 'Percent land surface') +
  theme(legend.position = 'none', strip.text.x = element_text(hjust = 0), panel.spacing.x=unit(.7, "lines"), strip.background = element_blank(), axis.line.y = element_blank(),  axis.text=element_text(size=rel(0.7)), panel.border = element_rect(colour = "grey20", fill=NA, size = 1))

biome15_plot + legend_long + plot_layout(widths = c(3, 1))
```



```{r}
ggsave('figures/biomes15.png', biome15_plot + legend_long + plot_layout(widths = c(3, 1))
, height = 10, width = 9, dpi = 600)
```


## HFP comparison

How well do the modern anthromes predict these variables compared to the max human footprint? The order is class -> level -> hfp_max for all of these except for ind50, which is hfp -> class -> level. Repeating for 100 threshold for the logistic regression, kba is the same but pa and ind have class -> hfp -> level. In all cases but ind50 the classes are better than the hfp. In all cases but ind50, ind, and pa are the levels better than hfp.

```{r}
pres_pred1 <- expand_grid(predictors = c('an_2017AD', 'hfp_max', 'level'),
                          predictands = c('v_thr', 'v_rich')) %>%
  mutate(aic = map2_dbl(predictands, predictors, calc_aic, fam = poisson(), 
                        dat = left_join(regression_dat, anthrome_key, by = c('an_2017AD' = 'class')))) %>%
  arrange(aic)

pres_pred2 <- expand_grid(predictors = c('an_2017AD', 'hfp_max', 'level'),
                          predictands = c('kba50', 'ind50', 'pa50')) %>%
  mutate(aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(), 
                        dat = left_join(regression_dat, anthrome_key, by = c('an_2017AD' = 'class')))) %>%
  arrange(aic)

pres_pred3 <- expand_grid(predictors = c('an_2017AD', 'hfp_max', 'level'),
                          predictands = c('kba', 'ind', 'pa')) %>%
  mutate(aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(),
                        dat = left_join(regression_dat, anthrome_key, by = c('an_2017AD' = 'class')))) %>%
  arrange(aic)
```
