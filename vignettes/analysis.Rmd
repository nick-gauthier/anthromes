---
title: "Anthromes"
author: "Nick Gauthier"
date: "6/30/2020"
output: html_document
---

# Setup


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stars)
library(tidyverse)
library(sf)
library(dggridR)
library(patchwork)


anthrome_key <- tibble(
  anthrome = c(11, 12, 21, 22, 23, 24, 31, 32, 33, 34, 41, 42, 43, 51, 
            52, 53, 54, 61, 62, 63, 70),
  class = factor(c('Urban', 'Mixed settlements', 'Rice villages', 'Irrigated villages', 
            'Rainfed villages', 'Pastoral villages', 'Residential irrigated croplands',
            'Residential rainfed croplands', 'Populated croplands', 'Remote croplands', 
            'Residential rangelands', 'Populated rangelands', 'Remote rangelands', 
            'Residential woodlands', 'Populated woodlands', 'Remote woodlands', 
            'Inhabited treeless & barren lands', 'Wild woodlands', 
            'Wild treeless and barren lands', 'Ice, uninhabited', 'NODATA'), 
            levels = c('Urban', 'Mixed settlements', 'Rice villages', 'Irrigated villages', 
            'Rainfed villages', 'Pastoral villages', 'Residential irrigated croplands',
            'Residential rainfed croplands', 'Populated croplands', 'Remote croplands', 
            'Residential rangelands', 'Populated rangelands', 'Remote rangelands', 
            'Residential woodlands', 'Populated woodlands', 'Remote woodlands', 
            'Inhabited treeless & barren lands', 'Wild woodlands', 
            'Wild treeless and barren lands', 'Ice, uninhabited', 'NODATA')),
  # level = factor(c('Dense settlements', 'Dense settlements', 'Villages', 'Villages', 
  #           'Villages', 'Villages', 'Croplands', 'Croplands', 'Croplands', 'Croplands', 
  #           'Rangelands', 'Rangelands', 'Rangelands', 'Seminatural', 'Seminatural', 
  #           'Seminatural', 'Seminatural', 'Wildlands', 'Wildlands', 'Wildlands', 'NODATA'), 
  #           levels = c('Dense settlements', 'Villages', 'Croplands',
  #           'Rangelands', 'Seminatural', 'Wildlands', 'NODATA')),
    level = factor(c('Settlements', 'Settlements', 'Settlements', 'Settlements', 
            'Settlements', 'Settlements', 'Croplands', 'Croplands', 'Croplands', 'Croplands', 
            'Rangelands', 'Rangelands', 'Rangelands', 'Seminatural', 'Seminatural', 
            'Seminatural', 'Seminatural', 'Wildlands', 'Wildlands', 'Wildlands', 'NODATA'), 
            levels = c('Settlements', 'Croplands',
            'Rangelands', 'Seminatural', 'Wildlands', 'NODATA')),
  type = factor(c('Used', 'Used', 'Used', 'Used', 'Used', 'Used', 'Used', 'Used', 'Used', 
           'Used', 'Used', 'Used', 'Used', 'Seminatural', 'Seminatural','Seminatural', 
           'Seminatural', 'Wild', 'Wild', 'Wild', 'NODATA'), levels = c('Used', 'Seminatural', 'Wild', 'NODATA'))
)

anthrome_class_color <- c('#A80000', '#FF0000', '#0070FF', '#00A9E6', '#A900E6', 
                  '#FF73DF', '#00FFC5', '#E6E600', '#FFFF73', '#FFFFBE', 
                  '#E69800', '#FFD37F', '#FFEBAF', '#38A800', '#A5F57A', 
                  '#D3FFB2', '#B2B2B2', '#DAF2EA', '#E1E1E1', '#FAFFFF', NA) %>%
  setNames(anthrome_key$class)

#anthrome_level_color <- c('Dense settlements' = '#CD6666', 'Villages' = '#AA66CD', 'Croplands' = '#FFFF00', 
#                 'Rangelands' = '#FFAA00', 'Seminatural' = '#D3FFBE', 'Wildlands' = '#38A800', NODATA = NA)

anthrome_level_color <- c('Settlements' = '#CD6666', 'Croplands' = '#FFFF00', 
                 'Rangelands' = '#FFAA00', 'Seminatural' = '#D3FFBE', 'Wildlands' = '#38A800', NODATA = NA)

anthrome_type_color <- c('Used' = '#EDCDCB', 'Seminatural' = '#FFFFFF', 'Wild' = '#CADAA9', NODATA = NA)

anthrome_class_color2 <- c('#A80000', '#FF0000', '#0070FF', '#00A9E6', '#A900E6', 
                  '#FF73DF', '#00FFC5', '#E6E600', '#FFFF73', '#FFFFBE', 
                  '#E69800', '#FFD37F', '#FFEBAF', '#38A800', '#A5F57A', 
                  '#D3FFB2', '#B2B2B2', '#DAF2EA', '#E1E1E1', '#FAFFFF', NA) %>%
  setNames(c(11, 12, 21, 22, 23, 24, 31, 32, 33, 34, 41, 42, 43, 51, 
            52, 53, 54, 61, 62, 63, 70))

time_steps <- c("10000BC", "9000BC", "8000BC", "7000BC", "6000BC", "5000BC", "4000BC", "3000BC", "2000BC", "1000BC", "0AD", "100AD", "200AD", "300AD", "400AD", "500AD", "600AD", "700AD", "800AD", "900AD", "1000AD", "1100AD", "1200AD", "1300AD", "1400AD", "1500AD", "1600AD",  "1700AD",  "1710AD",  "1720AD",  "1730AD",  "1740AD",  "1750AD",  "1760AD", "1770AD", "1780AD", "1790AD", "1800AD", "1810AD", "1820AD", "1830AD", "1840AD", "1850AD", "1860AD", "1870AD", "1880AD", "1890AD", "1900AD", "1910AD", "1920AD", "1930AD", "1940AD", "1950AD", "1960AD", "1970AD", "1980AD", "1990AD", "2000AD", "2001AD", "2002AD", "2003AD", "2004AD", "2005AD", "2006AD", "2007AD", "2008AD", "2009AD", "2010AD", "2011AD", "2012AD", "2013AD", "2014AD", "2015AD", "2016AD", "2017AD") 

time_steps_ordered <- factor(time_steps, levels = time_steps, ordered = TRUE)
 
recent_time_steps <-  c("2012AD",  "2013AD",  "2014AD",  "2015AD",  "2016AD",  "2017AD")
 
 time_steps_millennia <- c("10000BC", "9000BC", "8000BC", "7000BC", "6000BC", "5000BC", "4000BC", "3000BC", "2000BC", "1000BC", "0AD", "1000AD", "2000AD")
 
time_steps_centuries <- c("0AD", "100AD", "200AD", "300AD", "400AD", "500AD", "600AD", "700AD", "800AD", "900AD", "1000AD", "1100AD", "1200AD", "1300AD", "1400AD", "1500AD", "1600AD",  "1700AD",  "1800AD",  "1900AD", "2000AD")
 
 time_steps_decades <- c("1700AD", "1710AD",  "1720AD",  "1730AD",  "1740AD",  "1750AD",  "1760AD", "1770AD", "1780AD", "1790AD", "1800AD", "1810AD", "1820AD", "1830AD", "1840AD", "1850AD", "1860AD", "1870AD", "1880AD", "1890AD", "1900AD", "1910AD", "1920AD", "1930AD", "1940AD", "1950AD", "1960AD", "1970AD", "1980AD", "1990AD", "2000AD", "2010AD", "2017AD")
 
 years <- c(seq(-10000, -1000, 1000), 1,
           seq(100, 1700, 100),
           seq(1710, 2000, 10),
           seq(2001, 2017, 1))
 
time_key <- tibble(time_step = time_steps_ordered, year = years)

period_key <- tibble(time_step = time_steps_ordered) %>%
  mutate(millennia = time_step %in% time_steps_millennia,
         centuries = time_step %in% time_steps_centuries,
         decades = time_step %in% time_steps_decades)

biome_key <- tibble(biome_value = 1:15) %>%
  mutate(biome = case_when(biome_value %in% c(1, 2) ~ 'Tropical woodland',
                                         biome_value %in% c(3, 4, 5) ~ 'Temperate woodland',
                                         biome_value %in% c(6, 7) ~ 'Boreal woodland',
                                         biome_value == 8 ~ 'Mixed woodland',
                                         biome_value %in% c(9, 10) ~ 'Grassland, savanna, steppe',
                                         biome_value %in% c(11, 12) ~ 'Shrubland',
                                         biome_value == 13 ~ 'Tundra',
                                         biome_value == 14 ~ 'Desert and barren',
                                         biome_value == 15 ~ 'Ice, snow'),
         # define levels so plots have correct order
         biome = factor(biome, levels = c('Tropical woodland', 'Temperate woodland', 'Boreal woodland', 'Mixed woodland', 'Grassland, savanna, steppe', 'Shrubland', 'Tundra',	'Desert and barren', 'Ice, snow')))


region_key <- tibble(region = 1:8, region_name = c('Eurasia', 'Latin America and Caribbean', 'Near East', 'Africa', 'Asia', 'Europe', 'North America', 'Oceania'))
```


Import preprocessed data.

```{r}
an12_dgg_inputs <- read_sf('an12_dgg_inputs.shp') %>% rename(land_area = land_ar, pot_vill = pot_vll, region_name = regn_nm) %>%
  mutate(region_name = if_else(region_name == 'Latin America', 'Latin America and Caribbean', region_name))
an12_dgg <- read_csv('an12_dgg.csv')

total_land_area <- sum(an12_dgg_inputs$land_area)

contemp_vars <- read_sf('contemp_vars.shp') %>%
   mutate(pa = pa_km2 >= land_ar, ind = ind_cnt >= land_ar, kba = kba_km2 >= land_ar, pa50 = pa_km2 >= (0.5 * land_ar), ind50 = ind_cnt >= (0.5 * land_ar), kba50 = kba_km2 >= (0.5 * land_ar), v_rich = round(v_rich), v_thr = round(v_thr), hfp_max = round(hfp_max))
```
```{r}
contemp_vars %>% select(id, nmh, nmh_4, nmh_34) %>% rename(nmh_mode = nmh, nmh_4_frac = nmh_4, nmh_34_frac = nmh_34) %>%
  mutate(nmh_3_frac = nmh_34_frac - nmh_4_frac) %>%
  write_csv('nmh_natural_fraction.csv')
```




# Figure 1 - Global Summary

Summary proportion of global land area for each anthrome.
```{r}
anthromes_summary <- an12_dgg %>% 
  left_join(st_drop_geometry(an12_dgg_inputs), by = 'id') %>%
  select(-pot_veg, -pot_vill) %>%
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'anthrome') %>%
  mutate(anthrome= as.factor(anthrome)) %>%
  count(time_step, anthrome, wt = land_area, name = 'land_area', .drop = FALSE) %>%
  mutate(percent_land_area = land_area / total_land_area,
         anthrome = as.numeric(as.character(anthrome))) %>%
  left_join(anthrome_key, by = 'anthrome') %>%
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in%  c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  arrange(year, anthrome) %>%
  select(time_step, anthrome, class, percent_land_area, period, year)
```

```{r}
write_csv(anthromes_summary, 'an12_dgg_summary.csv')
```


Get hyde population data.
```{r}
hyde_pop <- readRDS('hyde_dgg') %>%
  select(contains('popc')) %>%
  mutate(id = readRDS('dgg_ids')) %>%
  filter(id %in% an12_dgg_inputs$id)

hyde_pop_all <- hyde_pop %>%
  select(-id) %>%
  summarise_all(sum, na.rm = TRUE) %>% 
  gather(key, population) %>%
  separate(key, into = c('var', 'time_step'), sep  = '_') %>%
  select(-var) %>%
  left_join(time_key) %>%
  select(year, population) %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  mutate(pop_percent = population / max(population))
```


```{r, fig.width=9, fig.height=3.5}
a <- anthromes_summary %>%
 ggplot(aes(as.factor(year), percent_land_area)) +
#  geom_area(aes(fill = class, color = class), position = 'stack') +
#  geom_col(aes(fill = class), color = 'lightgrey', size = .2)+
  geom_col(aes(fill = class, color = class), size = 1)+
  geom_hline(yintercept = c(.25, .50, .75), linetype = 2, alpha = .3) +
  geom_line(data = hyde_pop_all, aes(x = as.factor(year), y = pop_percent), color = 'maroon', linetype = 1, group = 1, size = 1.2) + 
  #geom_label(aes(label = label), data = tibble(year = 20010,  percent_land_area = 1, label = 'Population', period = factor('Decades', c('Millennia', 'Centuries', 'Decades')))) +
 facet_grid(~period, scales = 'free_x', space = 'free') +
  scale_color_manual(values = anthrome_class_color, name = 'Anthrome') +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome') +
      theme_classic() +
  scale_y_continuous(labels = scales::percent, expand = c(0,0.02)) +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1700, 1800, 1900, 2000),
                   labels = c('10000 ʙᴄᴇ', '5000 ʙᴄᴇ', '1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1700 ᴄᴇ', '1800 ᴄᴇ', '1900 ᴄᴇ', '2000 ᴄᴇ')) +
  labs(x = 'Year', y = 'Percent land surface') +
  theme(legend.position = 'bottom', plot.margin = margin(.2, .2,.2, r = .5, unit = 'cm'))
a

addSmallLegend <- function(myPlot, pointSize = 3, textSize = 8, spaceLegend = .8) {
    myPlot +
        guides(shape = guide_legend(override.aes = list(size = pointSize)),
               color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.text  = element_text(size = textSize),
              legend.key.size = unit(spaceLegend, "lines"))
}

a <- addSmallLegend(a)
ggsave('anthrome_areas_population.png', width = 9, height = 3.5)
```
# Figure 2 - Regional Summary

```{r}
region_summary <- an12_dgg %>% 
  mutate(region_name = an12_dgg_inputs$region_name, land_area = an12_dgg_inputs$land_area) %>% 
  pivot_longer(-c(id, land_area, region_name), names_to = 'time_step', values_to = 'anthrome') %>%
  left_join(anthrome_key, by = 'anthrome') %>% 
  select(time_step, region_name, land_area, class) %>%
  count(time_step, class, region_name, wt = land_area, name = 'land_area') %>% # add .drop = FALSE to preserve all levels
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  group_by(region_name, time_step) %>%
    mutate(percent_land_area = land_area / sum(land_area)) %>%
  select(time_step, region_name, class, percent_land_area, period, year)

write_csv(region_summary, 'an12_dgg_summary_region.csv')
```

```{r}
hyde_pop_regions <- hyde_pop %>%
  left_join(an12_dgg_inputs, by = 'id') %>% 
  select(-c(id:pot_vill), -geometry) %>%
  group_by(region_name) %>%
  summarise_all(sum, na.rm = TRUE) %>% 
  gather(key, population, -region_name) %>%
  separate(key, into = c('var', 'time_step'), sep  = '_') %>%
  select(-var) %>%
  left_join(time_key) %>%
  select(region_name, year, population) %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  group_by(region_name) %>%
  mutate(pop_percent = population / max(population))
```

```{r, fig.width = 6.5, fig.height = 7.5}
region_summary %>% 
  filter(class != 'Ice, uninhabited') %>%
 ggplot(aes(as.factor(year), percent_land_area)) +
  geom_col(aes(fill = class))+
      geom_line(data = hyde_pop_regions, aes(x = as.factor(year), y = pop_percent), color = 'darkred', linetype = 1, group = 1, size = .6) +
   facet_wrap(~region_name, scales = 'free_y', ncol= 1) +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome') +
    geom_vline(xintercept = c('1', '1700'), linetype = 2, color = 'red') +
   theme_classic() +
  scale_x_discrete(breaks = c(-8000, 1, 1000, 1700, 1800, 1900, 2000),
                   labels = c('80000 ʙᴄᴇ', '1 ᴄᴇ', '1000 ᴄᴇ', '1700 ᴄᴇ', '1800 ᴄᴇ', '1900 ᴄᴇ', '2000 ᴄᴇ')) +
  labs(x = 'Year', y = NULL) +
  theme(legend.position = 'none', strip.text.x = element_text(hjust = 0 ), panel.spacing.y=unit(.25, "lines"), strip.background = element_blank(), axis.line.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank())

ggsave('anthromes_summary_region.png', height = 7.5, width = 6.5)
```

```{r, fig.width = 10, fig.height=6}
map_dat <-  an12_dgg_inputs %>%
  left_join(an12_dgg) %>%
  transmute(anthrome = `2017AD`) %>%
  left_join(anthrome_key)

  ggplot(map_dat) +
  geom_sf(aes(fill = class), color = NA) +
  scale_fill_manual(values = anthrome_class_color)  +
     theme_bw() +
    theme(legend.position = 'NONE') +
    coord_sf(crs = st_crs("+proj=eck4"))
```


# Figure 3 - Biome summary
```{r}
biome_summary <- an12_dgg %>% 
  left_join(st_drop_geometry(an12_dgg_inputs), by = 'id') %>%
  select(-pot_vill, -region_name) %>%
        left_join(biome_key, by = c('pot_veg' = 'biome_value')) %>%
  select(-pot_veg) %>%
  pivot_longer(-c(id, land_area, biome), names_to = 'time_step', values_to = 'anthrome') %>%
  left_join(anthrome_key) %>%
  select(land_area, class, biome, time_step) %>%
  count(time_step, class, biome, wt = land_area, name = 'land_area', .drop = FALSE) %>%
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  group_by(biome, time_step) %>%
      mutate(percent_land_area = land_area / sum(land_area)) %>%
  select(time_step, biome, class, percent_land_area, period, year)

write_csv(biome_summary, 'an12_dgg_summary_biomes.csv')
```

```{r}
hyde_pop_biomes <- hyde_pop %>%
  left_join(an12_dgg_inputs, by = 'id') %>% 
  select(-id, -land_area, -pot_vill,-region_name, -geometry) %>%
      left_join(biome_key, by = c('pot_veg' = 'biome_value')) %>%
  select(-pot_veg) %>%
  group_by(biome) %>%
  summarise_all(sum, na.rm = TRUE) %>% 
  gather(key, population, -biome) %>%
  separate(key, into = c('var', 'time_step'), sep  = '_') %>%
  select(-var) %>%
  left_join(time_key, by = 'time_step') %>%
  select(biome, year, population) %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  group_by(biome) %>%
  mutate(pop_percent = population / max(population)) %>%
  ungroup() %>%
  filter(biome != 'Ice, snow')
```


```{r, fig.width = 6.5, fig.height = 7.5}
biome_summary %>% 
  filter(biome != 'Ice, snow', class != 'NODATA', class != 'Ice, uninhabited') %>%
 ggplot(aes(as.factor(year), percent_land_area)) +
  geom_col(aes(fill = class))+
    geom_line(data = hyde_pop_biomes, aes(x = as.factor(year), y = pop_percent), color = 'darkred', linetype = 1, group = 1, size = .6) +
   facet_wrap(~biome, scales = 'free_y', ncol = 1) +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome') +
      geom_vline(xintercept = c('1', '1700'), linetype = 2, color = 'red') +
   theme_classic() +
  scale_x_discrete(breaks = c(-8000, 1, 1000, 1700, 1800, 1900, 2000),
                   labels = c('8000 ʙᴄᴇ', '1 ᴄᴇ', '1000 ᴄᴇ', '1700 ᴄᴇ', '1800 ᴄᴇ', '1900 ᴄᴇ', '2000 ᴄᴇ')) +
  labs(x = 'Year', y = NULL) +
  theme(legend.position = 'none', strip.text.x = element_text(hjust = 0 ), panel.spacing.y=unit(.25, "lines"), strip.background = element_blank(), axis.line.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank())

ggsave('anthromes_summary_biome.png', height = 7.5, width = 6.5)
```


```{r, fig.width = 6, fig.height=5}
map <- an12_dgg_inputs %>%
  left_join(biome_key, by = c('pot_veg' = 'biome_value')) %>%
ggplot() +
  geom_sf(aes(fill = biome), color = NA) +
  scale_fill_brewer(palette = 'Spectral') +
     theme_bw() +
    theme(legend.position = 'bottom') +
    coord_sf(crs = st_crs("+proj=eck4"))
```

```{r, fig.height = 8, fig.width = 8}
map / bio + plot_layout(heights = c(2,1)) + plot_annotation(tag_levels = 'A')
```


# Figure 4 - Contemporary Data

## 4a Summaries
```{r}
contemp <- an12_dgg %>%
  select(id, `2017AD`) %>% # should be most recent time step?
  left_join(contemp_vars, by = 'id') %>%
  left_join(anthrome_key, by = c('2017AD' = 'anthrome'))
```

```{r}
unused_summary <- contemp_vars %>%
  select(id, land_ar) %>%
  st_drop_geometry() %>%
  remove_missing() %>%
  left_join(an12_dgg, by = 'id') %>% 
  filter(`2017AD` >= 50)  %>% # unused lands in 2017
  pivot_longer(-c(id, land_ar), names_to = 'time_step', values_to = 'anthrome') %>%
    left_join(anthrome_key, by = 'anthrome') %>% 
  select(id, time_step, land_ar, class) %>%
  count(time_step, class, wt = land_ar, name = 'var', .drop = FALSE) %>% 
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in%  c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  select(time_step, class, var, period, year)

ind_summary <- contemp_vars %>%
  select(id, ind_cnt) %>%
  st_drop_geometry() %>%
  remove_missing() %>%
  left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, ind_cnt), names_to = 'time_step', values_to = 'anthrome') %>%
    left_join(anthrome_key, by = 'anthrome') %>% 
  select(id, time_step, ind_cnt, class) %>%
  count(time_step, class, wt = ind_cnt, name = 'var', .drop = FALSE) %>% 
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in%  c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  select(time_step, class, var, period, year)

kba_summary <- contemp_vars %>%
  select(id, kba_km2) %>%
  st_drop_geometry() %>%
  remove_missing() %>%
  left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, kba_km2), names_to = 'time_step', values_to = 'anthrome') %>%
    left_join(anthrome_key, by = 'anthrome') %>% 
  select(id, time_step, kba_km2, class) %>%
  count(time_step, class, wt = kba_km2, name = 'var', .drop = FALSE) %>% 
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in%  c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  select(time_step, class, var, period, year)

pa_summary <- contemp_vars %>%
  select(id, pa_km2) %>%
  st_drop_geometry() %>%
  remove_missing() %>%
  left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, pa_km2), names_to = 'time_step', values_to = 'anthrome') %>%
   left_join(anthrome_key, by = 'anthrome') %>% 
  select(id, time_step, pa_km2, class) %>%
  count(time_step, class, wt = pa_km2, name = 'var', .drop = FALSE) %>% 
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in%  c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  select(time_step, class, var, period, year)

nmh4_summary <- contemp_vars %>%
  mutate(nmh4_km2 = nmh_4 * land_ar) %>%
  select(id, nmh4_km2) %>%
  st_drop_geometry() %>%
  left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, nmh4_km2), names_to = 'time_step', values_to = 'anthrome') %>%
    left_join(anthrome_key, by = 'anthrome') %>% 
  select(id, time_step, nmh4_km2, class) %>%
  count(time_step, class, wt = nmh4_km2, name = 'var', .drop = FALSE) %>% 
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in%  c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  select(time_step, class, var, period, year)

nmh3_summary <- contemp_vars %>%
  mutate(nmh3_km2 = (nmh_34 - nmh_4) * land_ar) %>%
  select(id, nmh3_km2) %>%
  st_drop_geometry() %>%
  left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, nmh3_km2), names_to = 'time_step', values_to = 'anthrome') %>%
    left_join(anthrome_key, by = 'anthrome') %>% 
  select(id, time_step, nmh3_km2, class) %>%
  count(time_step, class, wt = nmh3_km2, name = 'var', .drop = FALSE) %>% 
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in%  c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  select(time_step, class, var, period, year)

nmh3_summary <- contemp_vars %>%
  mutate(nmh3_km2 = (nmh_34 - nmh_4) * land_ar) %>%
  select(id, nmh3_km2) %>%
  st_drop_geometry() %>%
  left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, nmh3_km2), names_to = 'time_step', values_to = 'anthrome') %>%
    left_join(anthrome_key, by = 'anthrome') %>% 
  select(id, time_step, nmh3_km2, class) %>%
  count(time_step, class, wt = nmh3_km2, name = 'var', .drop = FALSE) %>% 
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in%  c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  select(time_step, class, var, period, year)

shared_3gc_summary <- contemp_vars %>%
  filter(X_3_c_4 == 2) %>%
  select(id, land_ar) %>%
  st_drop_geometry() %>%
  left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, land_ar), names_to = 'time_step', values_to = 'anthrome') %>%
    left_join(anthrome_key, by = 'anthrome') %>% 
  select(id, time_step, land_ar, class) %>%
  count(time_step, class, wt = land_ar, name = 'var', .drop = FALSE) %>% 
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in%  c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  select(time_step, class, var, period, year)

wild_3gc_summary <- contemp_vars %>%
  filter(X_3_c_4 == 3) %>%
  select(id, land_ar) %>%
  st_drop_geometry() %>%
  left_join(an12_dgg, by = 'id') %>% 
  pivot_longer(-c(id, land_ar), names_to = 'time_step', values_to = 'anthrome') %>%
    left_join(anthrome_key, by = 'anthrome') %>% 
  select(id, time_step, land_ar, class) %>%
  count(time_step, class, wt = land_ar, name = 'var', .drop = FALSE) %>% 
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in%  c(seq(1710, 2010, 10), 2017) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  select(time_step, class, var, period, year)
```


```{r, fig.height = 7.5, fig.width= 6.5}
bind_rows(kba_summary,pa_summary, ind_summary, unused_summary, nmh3_summary, nmh4_summary, shared_3gc_summary, wild_3gc_summary, .id = 'type') %>%
  mutate(type = factor(case_when(type == 1 ~ 'Key Biodiversity Areas',
                          type == 2 ~ 'Protected Areas',
                          type == 3 ~ 'Indigenous Lands',
                          type == 4 ~ 'Unused Anthromes (2017)',
                          type == 5 ~ 'Potential Natural (NMH)',
                          type == 6 ~ 'Likely Natural (NMH)',
                          type == 7 ~ 'Shared Lands (3GC)',
                          type == 8 ~ 'Large Wild Areas (3GC)'), levels = c('Key Biodiversity Areas','Protected Areas', 'Indigenous Lands', 'Unused Anthromes (2017)', 'Shared Lands (3GC)', 'Large Wild Areas (3GC)', 'Potential Natural (NMH)',  'Likely Natural (NMH)'))) %>%
  filter(class != 'NODATA') %>%
  mutate(var = var / total_land_area) %>%
 ggplot(aes(as.factor(year), var)) +
  geom_col(aes(fill = class))+
 facet_wrap(~type, scales = 'free_y', ncol = 1) + 
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome') +
      geom_vline(xintercept = c('1', '1700'), linetype = 2, color = 'red') +
      theme_classic() +
  scale_x_discrete(breaks = c(-8000, 1, 1000, 1700, 1800, 1900, 2000),
                   labels = c('8000 ʙᴄᴇ', '1 ᴄᴇ', '1000 ᴄᴇ', '1700 ᴄᴇ', '1800 ᴄᴇ', '1900 ᴄᴇ', '2000 ᴄᴇ')) +
  labs(x = 'Year', y = NULL) +
  theme(legend.position = 'none', strip.text.x = element_text(hjust = 0 ), panel.spacing.y=unit(.25, "lines"), strip.background = element_blank(), axis.line.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank())

ggsave('anthrome_summary_conservation.png', width = 6.5, height = 7.5)
```



```{r, fig.width = 10, fig.height = 5}
(a + b + plot_layout(guides = 'collect', widths = c(1.5, 1))) /  wrap_elements(full = e) + plot_layout(heights = c(1.5,1)) + plot_annotation(tag_levels = 'A')
#fig.width = 6.5, fig.asp = 2/3
ggsave('contemp_summary_levels.png', width = 10, height = 5)
```

## 4b Regression

```{r}
regression_dat <- an12_dgg %>%
  pivot_longer(-id, names_to = 'time', values_to = 'anthrome') %>%
  left_join(anthrome_key) %>%
  dplyr::select(-anthrome, -level, -type) %>%
  pivot_wider(names_from = time, values_from = class) %>%
  left_join(contemp_vars, by = 'id') %>%
  na.omit %>%
  select(id, land_ar, nmh, pop17, hfp_max:kba50, all_of(unique(c(time_steps_millennia, time_steps_centuries))), `2017AD`) %>%
  rename_with(~paste0('an_', .), all_of(unique(c(time_steps_millennia, time_steps_centuries, '2017AD')))) %>%
  left_join(an12_dgg_inputs %>%
    select(id, region_name) %>%
    st_drop_geometry()) %>%
  st_as_sf() %>%
  mutate(pt = st_centroid(.)) %>%
 mutate(lon = sf::st_coordinates(pt)[,1],
                lat = sf::st_coordinates(pt)[,2]) %>%
  select(-pt)
```





```{r}
calc_aic <- function(predictand, predictor, fam, dat){
  as.formula(paste(predictand, '~', predictor)) %>%
    glm(family = fam, data = dat) %>% 
    AIC
}

calc_aic_gam <- function(predictand, predictor, fam, dat){
  as.formula(paste(predictand, '~', predictor, '+ te(lon,lat)')) %>%
    bam(family = fam, data = dat) %>% 
    AIC
}
```


How well does the modern anthromes predict these variables compared to the max human footprint. also look at the anthrome levels. so the order is class -> level -> hfp_max for all of these except for ind50, which is hfp -> class -> level. repeating for 100 threshold for the logistic regression, kba is the same but pa and ind have class ->hfp -> level.

so in all cases bug ind50 the classes are better than the hfp. in all cases but ind50, ind, and pa are the levels better than hfp

```{r}
pres_pred1 <- expand_grid(predictors = c('an_2017AD', 'hfp_max', 'level'),
                   predictands = c('v_thr', 'v_rich')) %>%
  mutate(aic = map2_dbl(predictands, predictors, calc_aic, fam = poisson(), dat = left_join(regression_dat, anthrome_key, by = c('an_2017AD' = 'class')))) %>%
  arrange(aic)

pres_pred2 <- expand_grid(predictors = c('an_2017AD', 'hfp_max', 'level'),
                   predictands = c('kba50', 'ind50', 'pa50')) %>%
  mutate(aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(), dat = left_join(regression_dat, anthrome_key, by = c('an_2017AD' = 'class')))) %>%
  arrange(aic)

pres_pred3 <- expand_grid(predictors = c('an_2017AD', 'hfp_max', 'level'),
                   predictands = c('kba', 'ind', 'pa')) %>%
  mutate(aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(),dat = left_join(regression_dat, anthrome_key, by = c('an_2017AD' = 'class')))) %>%
  arrange(aic)
```

```{r}
```




Fit glms for all the variables on a global scale.

```{r}
global_legacy_glm1 <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('hfp_max', 'v_thr', 'v_rich')) %>%
  mutate(predictors =  paste0('an_', time_step),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = poisson(), dat = regression_dat))

global_legacy_glm2 <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('kba50', 'ind50', 'pa50')) %>%
  mutate(predictors =  paste0('an_', time_step),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(), dat = regression_dat))

global_legacy_glm3 <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('kba', 'ind', 'pa')) %>%
  mutate(predictors =  paste0('an_', time_step),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(), dat = regression_dat))
```


plot the results
```{r}
bind_rows(global_legacy_glm1,global_legacy_glm2) %>%
  left_join(time_key) %>%
    mutate(vars = factor(predictands, levels = rev(c('v_rich', 'v_thr', 'kba50','hfp_max', 'pa50',  'ind50')))) %>%
  group_by(vars) %>%
  mutate(aic_scaled = scales::rescale(aic)) %>%
  ggplot(aes(as.factor(year), vars, fill = aic_scaled), color = 'white') +
  geom_tile() +
    geom_vline(xintercept = '-1000', color = 'red', linetype = 2) +
  scale_fill_viridis_c(direction = -1, name = 'Scaled AIC', breaks = c(.05, .95), labels = c('Best', 'Worst')) +
  theme_classic() +
  scale_y_discrete(labels = c('Indigenous Lands', 'Protected Lands', 'Human Footprint (max)', 'Key Biodiversity Areas', 'Threatened Species Richness', 'Species Richness')) +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1500, 2000),
                   labels = c('10000 ᴄᴇ', '5000 ᴄᴇ', '1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1500 ᴄᴇ', '2000 ᴄᴇ'))  +
  labs(x = 'Predictor Year', y = NULL) +
  theme(strip.background = element_blank()) +
  coord_fixed()
```
Compare the thresholds for the logistic regressions. it looks like the difference matters most for kba.
```{r}
bind_rows(global_legacy_glm2,global_legacy_glm3) %>%
  left_join(time_key) %>%
    mutate(vars = factor(predictands, levels = rev(c('kba', 'kba50', 'pa', 'pa50','ind', 'ind50')))) %>%
  group_by(vars) %>%
  mutate(aic_scaled = scales::rescale(aic)) %>%
  ggplot(aes(as.factor(year), vars, fill = aic_scaled), color = 'white') +
  geom_tile() +
    geom_vline(xintercept = '-1000', color = 'red', linetype = 2) +
  scale_fill_viridis_c(direction = -1, name = 'Scaled AIC', breaks = c(.05, .95), labels = c('Best', 'Worst')) +
  theme_classic() +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1500, 2000),
                   labels = c('10000 ᴄᴇ', '5000 ᴄᴇ', '1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1500 ᴄᴇ', '2000 ᴄᴇ'))  +
  labs(x = 'Predictor Year', y = NULL) +
  theme(strip.background = element_blank()) +
  coord_fixed()
```
for jbam 

```{r}
bind_rows(global_legacy_glm1,global_legacy_glm2) %>%
  group_by(predictands) %>%
  filter(aic == min(aic)) %>%
  bind_rows(., pres_pred1, pres_pred2) %>%
  arrange(aic)
```

now try with the spatial smoother

```{r}
global_legacy_gam <- expand_grid(predictors = c('hfp_max', 'an_2017AD'),
                   predictands = c('v_thr', 'v_rich')) %>%
  mutate(aic = map2_dbl(predictands, predictors, calc_aic_gam, fam = poisson(), dat = regression_dat))
```


```{r}
global_legacy_gam1 <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('hfp_max', 'v_thr', 'v_rich')) %>%
  mutate(predictors =  paste0('an_', time_step),
         aic = map2_dbl(predictands, predictors, calc_aic_gam, fam = poisson(), dat = regression_dat))

global_legacy_gam2 <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('kba50', 'ind50', 'pa50')) %>%
  mutate(predictors =  paste0('an_', time_step),
         aic = map2_dbl(predictands, predictors, calc_aic_gam, fam = binomial(), dat = regression_dat))

global_legacy_gam3 <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('kba', 'ind', 'pa')) %>%
  mutate(predictors =  paste0('an_', time_step),
         aic = map2_dbl(predictands, predictors, calc_aic_gam, fam = binomial(), dat = regression_dat))

```

```{r}
test_aic_class1a <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('hfp_max', 'v_thr', 'v_rich')) %>%
  mutate(predictors =  paste0('an_', time_step),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = poisson(), dat = filter(regression_dat, nmh == 1))) %>%
  mutate(nmh = 'NMH1')

test_aic_class2a <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('hfp_max', 'v_thr', 'v_rich')) %>%
  mutate(predictors = paste0('`', time_step, '`'),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = poisson(), dat = filter(regression_dat, nmh == 2)))  %>%
  mutate(nmh = 'NMH2')

test_aic_class3a <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('hfp_max', 'v_thr', 'v_rich')) %>%
  mutate(predictors = paste0('`', time_step, '`'),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = poisson(), dat = filter(regression_dat, nmh == 3)))  %>%
  mutate(nmh = 'NMH3')
test_aic_class4a <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('hfp_max', 'v_thr', 'v_rich')) %>%
  mutate(predictors = paste0('`', time_step, '`'),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = poisson(), dat = filter(regression_dat, nmh == 4)))  %>%
  mutate(nmh = 'NMH4')

test_aic_class1b <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('kba50', 'ind50', 'pa50')) %>%
  mutate(predictors = paste0('`', time_step, '`'),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(), dat = filter(regression_dat, nmh == 1)))  %>%
  mutate(nmh = 'NMH1')

test_aic_class2b <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('kba50', 'ind50', 'pa50')) %>%
  mutate(predictors = paste0('`', time_step, '`'),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(), dat = filter(regression_dat, nmh == 2)))  %>%
  mutate(nmh = 'NMH2')

test_aic_class3b <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('kba50', 'ind50', 'pa50')) %>%
  mutate(predictors = paste0('`', time_step, '`'),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(), dat = filter(regression_dat, nmh == 3))) %>%
  mutate(nmh = 'NMH3')

test_aic_class4b <- expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('kba50', 'ind50', 'pa50')) %>%
  mutate(predictors = paste0('`', time_step, '`'),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(), dat = filter(regression_dat, nmh == 4))) %>%
  mutate(nmh = 'NMH4')


test_dat <- bind_rows(test_aic_class1a, test_aic_class1b,test_aic_class2a, test_aic_class2b,test_aic_class3a, test_aic_class3b,test_aic_class4a, test_aic_class4b) %>%
  left_join(time_key)
```

```{r}
 test_dat %>%
    mutate(vars = factor(predictands, levels = rev(c('v_rich', 'v_thr', 'kba50','hfp_max', 'pa50',  'ind50')))) %>%
  group_by(vars, nmh) %>%
  mutate(aic_scaled = scales::rescale(aic)) %>%
  ggplot(aes(as.factor(year), vars, fill = aic_scaled), color = 'white') +
  geom_tile() +
    geom_vline(xintercept = '-1000', color = 'red', linetype = 2) +
  facet_wrap(~nmh, ncol = 1) +
  scale_fill_viridis_c(direction = -1, name = 'Scaled AIC', breaks = c(.05, .95), labels = c('Best', 'Worst')) +
  theme_classic() +
  scale_y_discrete(labels = c('Indigenous Lands', 'Protected Lands', 'Human Footprint (max)', 'Key Biodiversity Areas', 'Threatened Species Richness', 'Species Richness')) +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1500, 2000),
                   labels = c('10000 ᴄᴇ', '5000 ᴄᴇ', '1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1500 ᴄᴇ', '2000 ᴄᴇ'))  +
  labs(x = 'Predictor Year', y = NULL) +
  theme(strip.background = element_blank())
```

```{r}
region_key
```

```{r}
test_dat <- regression_dat %>% 
  select(-geometry) %>%
  group_nest(region_name)
```

```{r}
fit_mod1 <- function(x) {
  expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('hfp_max', 'v_thr', 'v_rich')) %>%
  mutate(predictors = paste0('an_', time_step),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = poisson(), dat = x))
}

fit_mod2 <- function(x) {
  expand_grid(time_step = unique(c(time_steps_millennia, time_steps_centuries)),
                   predictands = c('kba50', 'ind50', 'pa50')) %>%
  mutate(predictors = paste0('an_', time_step),
         aic = map2_dbl(predictands, predictors, calc_aic, fam = binomial(), dat = x))
}
```


```{r}
t1 <- test_dat %>%
  mutate(mod = map(data, fit_mod1)) %>%
  select(-data)

t2 <- test_dat %>%
  mutate(mod = map(data, fit_mod2)) %>%
  select(-data)

test_dat2 <- bind_rows(t1, t2) %>%
  unnest(mod) %>%
  left_join(time_key)
```

```{r}
 test_dat2 %>%
    mutate(vars = factor(predictands, levels = rev(c('v_rich', 'v_thr', 'kba50','hfp_max', 'pa50',  'ind50')))) %>%
  group_by(vars, region_name) %>%
  mutate(aic_scaled = scales::rescale(aic)) %>%
  ggplot(aes(as.factor(year), vars, fill = aic_scaled), color = 'white') +
  geom_tile() +
    geom_vline(xintercept = '-1000', color = 'red', linetype = 2) +
  facet_wrap(~region_name, ncol = 1) +
  scale_fill_viridis_c(direction = -1, name = 'Scaled AIC', breaks = c(.05, .95), labels = c('Best', 'Worst')) +
  theme_classic() +
  scale_y_discrete(labels = c('Indigenous Lands', 'Protected Lands', 'Human Footprint (max)', 'Key Biodiversity Areas', 'Threatened Species Richness', 'Species Richness')) +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1500, 2000),
                   labels = c('10000 ᴄᴇ', '5000 ᴄᴇ', '1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1500 ᴄᴇ', '2000 ᴄᴇ'))  +
  labs(x = 'Predictor Year', y = NULL) +
  theme(strip.background = element_blank())
```


```{r}
reg_dat34 <- regression_dat %>% filter(nmh_34 > 0.5 )
reg_dat4 <- regression_dat %>% filter(nmh_4  > 0.5)

test_aic_class2 <- expand_grid(time_step = time_steps_centuries,
                   predictands = c('kba50', 'ind50', 'pa50')) %>%
  mutate(predictors = paste0('`', time_step, '`'),
         aic = map2_dbl(predictands, predictors, calc_aic2)) %>%
  left_join(time_key)

test_aic_class3 <- expand_grid(time_step = time_steps_centuries,
                   predictands = c('kba', 'ind', 'pa')) %>%
  mutate(predictors = paste0('`', time_step, '`'),
         aic = map2_dbl(predictands, predictors, calc_aic2)) %>%
  left_join(time_key)


#library(nnet)
#
#calc_aic3 <- function(predictand, predictor){
#  as.formula(paste(predictand, '~', predictor)) %>%
#    multinom(data = reg_dat34) %>% 
#    AIC
#}
#test_aic_class3 <- expand_grid(time_step = time_steps_centuries,
#                   predictands = c('`2017AD`')) %>%
#  mutate(predictors = paste0('`', time_step, '`'),
#         aic = map2_dbl(predictands, predictors, calc_aic3)) %>%
#  left_join(time_key)

preds_order <- bind_rows(test_aic_class, test_aic_class2, test_aic_class3) %>%
  group_by(predictands) %>%
  mutate(aic_scaled = scales::rescale(aic)) %>%
  filter(aic_scaled == min(aic_scaled)) %>%
  arrange(year) %>%
  pull(predictands)
```

```{r}
#fig.width = 6, fig.height=2
e <- bind_rows(test_aic_class, test_aic_class2) %>%
  #mutate(vars = factor(predictands, levels = rev(c('v_rich', 'v_thr', 'kba50', 'kba', 'hfp_max', 'pa50', 'pa', 'ind50', 'ind')))) %>%
    mutate(vars = factor(predictands, levels = rev(c('v_rich', 'v_thr', 'kba50','hfp_max', 'pa50',  'ind50')))) %>%
  group_by(vars) %>%
  mutate(aic_scaled = scales::rescale(aic)) %>%
  ggplot(aes(as.factor(year), vars, fill = aic_scaled), color = 'white') +
  geom_tile() +
  scale_fill_viridis_c(direction = -1, name = 'Scaled AIC', breaks = c(.05, .95), labels = c('Best', 'Worst')) +
  theme_classic() +
  scale_y_discrete(labels = c('Indigenous Lands', 'Protected Lands', 'Human Footprint (max)', 'Key Biodiversity Areas', 'Threatened Species Richness', 'Species Richness')) +
  scale_x_discrete(breaks = c(1, 500, 1000, 1500, 2000),
                   labels = c('1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1500 ᴄᴇ', '2000 ᴄᴇ'))  +
  labs(x = 'Predictor Year', y = NULL)
e
ggsave(e, 'anthrome_legacies34.png', height = 2, width = 6)
```

```{r, fig.width=6, fig.height=3}
e
```

```{r}
bind_rows(test_aic_class, test_aic_class2, test_aic_class3) %>%
  group_by(predictands) %>%
  mutate(aic_scaled = scales::rescale(aic)) %>%
  ggplot(aes(year, aic)) +
  geom_line() +
  geom_point() +
  facet_wrap(~predictands, scales = 'free_y') +
  theme_minimal()
```



```{r}
bllep <- expand_grid(time_step = time_steps_centuries,
                   predictands = c('kba', 'ind', 'pa')) %>%
  mutate(predictors = paste0('`', time_step, '`'),
         gof = map2_dbl(predictands, predictors, glemp)) %>%
  left_join(time_key)
glemp <- function(predictand, predictor){
  mod <- as.formula(paste(predictand, '~', predictor)) %>%
    glm(family = binomial, data = regression_dat)
  
    with(summary(mod), 1 - deviance/null.deviance)
}


bllep%>%
  group_by(predictands) %>%
  mutate(aic_scaled = scales::rescale(aic),
         aic_test = aic / min(aic)) %>%
  ggplot(aes(as.factor(year), predictands, fill = aic), color = 'white') +
  geom_tile() +
  scale_fill_viridis_c(direction = 1) +
  theme_classic() +
  scale_x_discrete(breaks = c(1, 500, 1000, 1500, 2000),
                   labels = c('1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1500 ᴄᴇ', '2000 ᴄᴇ'))  +
  coord_fixed()
```



```{r}
hist(contemp_vars$ind_cnt)
hist(contemp_vars$pa_km2)
hist(contemp_vars$kba_km2)
hist(contemp_vars$max)
hist(contemp_vars$v_rich)
hist(contemp_vars$v_thr)
hist(contemp_vars$nmh_34)
hist(contemp_vars$nmh_4)
```

```{r}
sum(contemp_vars$nmh_4 == 1)
sum(contemp_vars$nmh_34 == 1);sum(contemp_vars$nmh_34 > .99)

```



```{r}
# check out some regressions
m1 <- bam(v_rich ~te(lon,lat), family = poisson, data = test_dat2) 
m2 <- bam(v_rich ~ an_2000AD + te(lon,lat), family = poisson, data = filter(regression_dat, region_name == 'Latin America'))
m3 <- bam(v_rich ~ an_10000BC+ te(lon,lat), family = poisson, data = filter(regression_dat, region_name == 'Latin America')) 

AIC(m1,m2,m3, m4)

plot(m4)
summary(m2)
summary(m4)
plot(m5)

gam.check(m7)
```



```{r}
test <- regression_dat %>%
  filter(region_name == 'Latin America') %>%
  modelr::add_predictions(m1, var = 'tensor',type = 'response') %>%
  modelr::add_predictions(m2, var = 'pred2000',type = 'response') %>%
   modelr::add_predictions(m3, var = 'pred2017',type = 'response') %>%
     modelr::add_predictions(m4, var = 'pred10000', type = 'response')
```

```{r}
test %>%
#st_crop(st_bbox(c(xmin = -100, xmax = -50, ymin = 0, ymax = 20))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = v_rich), color = NA) +
  scale_fill_viridis_c(limits = c(0, 950)) +
  coord_sf(crs = st_crs("+proj=eck4"))

test %>%
#st_crop(st_bbox(c(xmin = -100, xmax = -50, ymin = -10, ymax = 20))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = tensor), color = NA) +
  scale_fill_viridis_c(limits = c(0,950)) +
  coord_sf(crs = st_crs("+proj=eck4"))

test %>%
#st_crop(st_bbox(c(xmin = -100, xmax = -50, ymin = -10, ymax = 20))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = pred2000), color = NA) +
  scale_fill_viridis_c(limits = c(0,950)) +
  coord_sf(crs = st_crs("+proj=eck4"))

test %>%
#st_crop(st_bbox(c(xmin = -100, xmax = -50, ymin = -10, ymax = 20))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = pred10000), color = NA) +
  scale_fill_viridis_c(limits = c(0,950)) +
  coord_sf(crs = st_crs("+proj=eck4"))

test %>%
#st_crop(st_bbox(c(xmin = -100, xmax = -50, ymin = -10, ymax = 20))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = pred2017), color = NA) +
  scale_fill_viridis_c(limits = c(0,950)) +
  coord_sf(crs = st_crs("+proj=eck4"))
```

```{r}
test %>%
  ggplot() +
  geom_sf(aes(fill = v_thr), color = NA) +
  scale_fill_viridis_c() +
  coord_sf(crs = st_crs("+proj=eck4"))
```


compare regressions to hfp_max
```{r}
m1 <- glm(v_thr ~ `1500AD`, family = poisson, data = regression_dat)
with(summary(m1), 1 - deviance/null.deviance)

m2 <- glm(v_thr ~ `2000AD`, family = poisson, data = regression_dat)
with(summary(m2), 1 - deviance/null.deviance)

m3 <- glm(v_thr ~ as.factor(X_3_c_4), family = poisson, data = regression_dat)
with(summary(m3), 1 - deviance/null.deviance)

m4 <- glm(v_thr ~ as.factor(landsut), family = poisson, data = regression_dat)
with(summary(m4), 1 - deviance/null.deviance)

AIC(m1,m2,m3,m4)



m4 <- glm(kba ~ `1500AD`, family = binomial, data = regression_dat)
with(summary(m4), 1 - deviance/null.deviance)

m5 <- glm(kba ~ `2000AD`, family = binomial, data = regression_dat)
with(summary(m5), 1 - deviance/null.deviance)

m6 <- glm(kba ~ `hfp_max`, family = binomial, data = regression_dat)
with(summary(m6), 1 - deviance/null.deviance)

AIC(m4,m5,m6)

m4 <- glm(pa ~ `1500AD`, family = binomial, data = regression_dat)
with(summary(m4), 1 - deviance/null.deviance)

m5 <- glm(pa ~ `2000AD`, family = binomial, data = regression_dat)
with(summary(m5), 1 - deviance/null.deviance)

m6 <- glm(pa ~ `hfp_max`, family = binomial, data = regression_dat)
with(summary(m6), 1 - deviance/null.deviance)
regression_dat
```



```{r}
m1 <- glm(pa_km2 > 0 ~ `2000AD`, family = binomial, data = regression_dat)
m2 <- glm(pa_km2 > 0 ~ `600AD`, family = binomial, data = regression_dat)
m3 <- glm(pa_km2 > 1 ~ `2000AD`, family = binomial, data = regression_dat)
m4 <- glm(pa_km2 > 1 ~ `600AD`, family = binomial, data = regression_dat)
AIC(m1, m2);AIC(m3, m4)

t1 <- regression_dat %>%
  modelr::add_predictions(m1, var = 'pred2000', type = 'response') %>%
    modelr::add_predictions(m2, var = 'pred600', type = 'response')


t1 %>% select(pred2000, pred600, geometry) %>%
  st_as_sf %>%
  st_crop(st_bbox(c(xmin = 0, xmax = 60, ymin = 20, ymax = 60))) %>% # comment out for whole world
  gather(key, value, pred2000:pred600) %>%
  ggplot()+
  geom_sf(aes(fill = value), color = NA) +
  facet_wrap(~key) +
  scale_fill_viridis_c() +
  coord_sf(crs = st_crs("+proj=eck4"))


summary(m2);summary(m1)
```

```{r}
t1 %>% st_as_sf %>%
  st_crop(st_bbox(c(xmin = 0, xmax = 60, ymin = 20, ymax = 60))) %>% # comment out for whole world
  ggplot()+
  geom_sf(aes(fill = pa_km2), color = NA) +
  scale_fill_viridis_c() +
  coord_sf(crs = st_crs("+proj=eck4"))

t1 %>% st_as_sf %>%
  st_crop(st_bbox(c(xmin = 0, xmax = 60, ymin = 20, ymax = 60))) %>% # comment out for whole world
  ggplot()+
  geom_sf(aes(fill = pa_km2 >0), color = NA) +
  scale_fill_viridis_d() +
  coord_sf(crs = st_crs("+proj=eck4"))

t1 %>% st_as_sf %>%
  st_crop(st_bbox(c(xmin = 0, xmax = 60, ymin = 20, ymax = 60))) %>% # comment out for whole world
  ggplot()+
  geom_sf(aes(fill = pa_km2 >10), color = NA) +
  scale_fill_viridis_d() +
  coord_sf(crs = st_crs("+proj=eck4"))

t1 %>% st_as_sf %>%
  st_crop(st_bbox(c(xmin = 0, xmax = 30, ymin = 40, ymax = 60))) %>% # comment out for whole world
  ggplot()+
  geom_sf(aes(fill = ind_cnt), color = NA) +
  scale_fill_viridis_d() +
  coord_sf(crs = st_crs("+proj=eck4"))
```



```{r}
library(glmnet)
regression_mat <-  model.matrix(~ .-1,  dplyr::select(regression_dat, any_of(time_steps_centuries)))
# this doesn't treat the predictand as a factor
test_mod <- cv.glmnet(regression_mat, pull(regression_dat, kba50), family = 'binomial', intercept = FALSE, standardize = FALSE)
test_mod
plot(test_mod)

coef(test_mod, s= "lambda.1se")

```

```{r}
regression_mat <-  model.matrix(~ .-1,  dplyr::select(regression_dat, any_of(time_steps_centuries)))
# this doesn't treat the predictand as a factor
test_mod2 <- cv.glmnet(regression_mat, pull(regression_dat, v_thr), family = 'poisson', intercept = FALSE, standardize = FALSE)
test_mod2
plot(test_mod2)

coef(test_mod, s= "lambda.1se")

```



# Onsets
```{r}
suppressWarnings(
  onset_seminatural <- an12_dgg %>%
    pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
  group_by(id) %>%
    filter(anthrome < 61) %>%
    left_join(time_key) %>%
  summarise(onset = min(year))
)

suppressWarnings(
  onset_used <- an12_dgg %>%
    pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
  group_by(id) %>%
    filter(anthrome < 51) %>%
    left_join(time_key) %>%
  summarise(onset = min(year))
)

onsets <- bind_rows(dplyr::select(an12_dgg_inputs, id) %>% left_join(onset_seminatural), 
                    dplyr::select(an12_dgg_inputs, id) %>% left_join(onset_used), .id = 'type') %>%
 mutate(type = if_else(type == 1, 'Onset of Seminatural Anthromes', 'Onset of Used Anthromes')) %>%
  left_join(time_key, by = c('onset' = 'year')) %>%
  st_as_sf() %>%
  st_set_crs(4326)
```

```{r}
onsets %>%
  dplyr::select(-time_step) %>%
  spread(type, onset) %>%
  write_sf('anthromes_onsets_wide.shp')
write_sf(onsets, 'anthromes_onsets.shp')
```


```{r fig.width = 10, fig.height=12}
onsets %>%
  mutate(onset = 2017 - onset) %>%
 #   st_crop(st_bbox(c(xmin = 20, xmax = 40, ymin = 30, ymax = 40))) %>% # comment out for whole world
ggplot() +
  geom_sf(aes(fill = onset, geometry = geometry), color = NA)+
  scale_fill_viridis_c(option = 'A', na.value = 'lightgrey', direction = 1, trans = 'log') +
  facet_wrap(~type, nrow = 2)  +
  theme_bw() +
    coord_sf(crs = st_crs("+proj=eck4"))
```


# Treemap

```{r, fig.width = 10, fig.height=4.5}
library(treemapify)

anthromes_summary %>%
  filter(year %in% c(1, 1000, 2000)) %>%
  mutate(year = paste(year, 'CE')) %>%
  ggplot(aes(area = as.numeric(area), fill  = class, label = class, subgroup = level)) +
  geom_treemap() +
  geom_treemap_subgroup_border(color = 'black') +
    facet_wrap(~year) +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome')  +
  theme(legend.position  = 'bottom') +
  geom_treemap_subgroup_text(reflow = TRUE, fontface = 'italic', alpha = .8)

ggsave('treeplot1.png', width = 10, height = 4.5)
```

```{r, fig.height=10, fig.width = 10}
anthromes_summary %>%
  filter(year %in% c(1700, 1800, 1900, 2000)) %>%
  mutate(year = paste(year, 'CE')) %>%
  ggplot(aes(area = as.numeric(area), fill  = class, label = class, subgroup = level)) +
  geom_treemap() +
  geom_treemap_subgroup_border(color = 'black') +
    facet_wrap(~year) +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome')  +
  theme(legend.position  = 'bottom') +
  geom_treemap_subgroup_text(reflow = TRUE, fontface = 'italic', alpha = .8)

ggsave('treeplot2.png', width = 10, height = 10)
```

# Alluvial plots

```{r}
library(ggalluvial)
test <- anthromes_dat %>% 
  filter(year %in% c(0, 500, 1000, 1500, 2000)) %>%
  left_join(anthrome_key)
  
ggplot(test, aes(x = as.factor(year), stratum = level, fill = level, label = level, alluvium = interaction(x,y), y = as.numeric(area))) +
    geom_flow() +
  geom_stratum(alpha = .5) +
  scale_fill_manual(values = anthrome_level_color, name = 'Anthrome')  +
  theme(legend.position  = 'bottom') +
  geom_text(stat = 'stratum', size = 3) +
  theme_minimal()
```


# Correlograms

```{r}
library(corrplot)
periods <- anthromes_summary %>%
  group_by(period) %>%
  nest

periods %>%
  mutate(data = map(data, ~  select(., year, area, class) %>%
  pivot_wider(names_from = class, values_from = area) %>%
  select(-year) %>%
    cor)) %>%
  pull(data) %>%
  map(~ corrplot(., method = 'color', type = 'lower'))


cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}

test2%>%
  cor %>%
  corrplot(method = 'color', type = 'lower', order = 'hclust', p.mat = cor.mtest(test2), sig.level = 0.01, insig = 'blank')
```

