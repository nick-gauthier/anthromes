---
title: "Anthromes"
author: "Nick Gauthier"
date: "6/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stars)
library(tidyverse)

anthrome_key <- tibble(
  value = c(11, 12, 21, 22, 23, 24, 31, 32, 33, 34, 41, 42, 43, 51, 
            52, 53, 54, 61, 62, 63, 70),
  class = factor(c('Urban', 'Mixed settlements', 'Rice villages', 'Irrigated villages', 
            'Rainfed villages', 'Pastoral villages', 'Residential irrigated croplands',
            'Residential rainfed croplands', 'Populated croplands', 'Remote croplands', 
            'Residential rangelands', 'Populated rangelands', 'Remote rangelands', 
            'Residential woodlands', 'Populated woodlands', 'Remote woodlands', 
            'Inhabited treeless & barren lands', 'Wild woodlands', 
            'Wild treeless and barren lands', 'Ice, uninhabited', 'NODATA'), 
            levels = c('Urban', 'Mixed settlements', 'Rice villages', 'Irrigated villages', 
            'Rainfed villages', 'Pastoral villages', 'Residential irrigated croplands',
            'Residential rainfed croplands', 'Populated croplands', 'Remote croplands', 
            'Residential rangelands', 'Populated rangelands', 'Remote rangelands', 
            'Residential woodlands', 'Populated woodlands', 'Remote woodlands', 
            'Inhabited treeless & barren lands', 'Wild woodlands', 
            'Wild treeless and barren lands', 'Ice, uninhabited', 'NODATA')),
  level = factor(c('Dense settlements', 'Dense settlements', 'Villages', 'Villages', 
            'Villages', 'Villages', 'Croplands', 'Croplands', 'Croplands', 'Croplands', 
            'Rangelands', 'Rangelands', 'Rangelands', 'Seminatural', 'Seminatural', 
            'Seminatural', 'Seminatural', 'Wildlands', 'Wildlands', 'Wildlands', 'NODATA'), 
            levels = c('Dense settlements', 'Villages', 'Croplands',
            'Rangelands', 'Seminatural', 'Wildlands', 'NODATA')),
  type = factor(c('Used', 'Used', 'Used', 'Used', 'Used', 'Used', 'Used', 'Used', 'Used', 
           'Used', 'Used', 'Used', 'Used', 'Seminatural', 'Seminatural','Seminatural', 
           'Seminatural', 'Wild', 'Wild', 'Wild', 'NODATA'), levels = c('Used', 'Seminatural', 'Wild', 'NODATA'))
)

anthrome_class_color <- c('#A80000', '#FF0000', '#0070FF', '#00A9E6', '#A900E6', 
                  '#FF73DF', '#00FFC5', '#E6E600', '#FFFF73', '#FFFFBE', 
                  '#E69800', '#FFD37F', '#FFEBAF', '#38A800', '#A5F57A', 
                  '#D3FFB2', '#B2B2B2', '#DAF2EA', '#E1E1E1', '#FAFFFF', NA) %>%
  setNames(anthrome_key$class)

anthrome_level_color <- c('Dense settlements' = '#CD6666', 'Villages' = '#AA66CD', 'Croplands' = '#FFFF00', 
                 'Rangelands' = '#FFAA00', 'Seminatural' = '#D3FFBE', 'Wildlands' = '#38A800', NODATA = NA)

anthrome_type_color <- c('Used' = '#EDCDCB', 'Seminatural' = '#FFFFFF', 'Wild' = '#CADAA9', NODATA = NA)

anthrome_class_color2 <- c('#A80000', '#FF0000', '#0070FF', '#00A9E6', '#A900E6', 
                  '#FF73DF', '#00FFC5', '#E6E600', '#FFFF73', '#FFFFBE', 
                  '#E69800', '#FFD37F', '#FFEBAF', '#38A800', '#A5F57A', 
                  '#D3FFB2', '#B2B2B2', '#DAF2EA', '#E1E1E1', '#FAFFFF', NA) %>%
  setNames(c(11, 12, 21, 22, 23, 24, 31, 32, 33, 34, 41, 42, 43, 51, 
            52, 53, 54, 61, 62, 63, 70))
```

Import the anthromes raster.
```{r, cache=TRUE}
years <- c(seq(-10000, 0, 1000),
           seq(100, 1700, 100),
           seq(1710, 2000, 10),
           seq(2001, 2015, 1))

anthromes <- here::here('vignettes/data/raw_data/anthromes_all.tif') %>%
  read_stars() %>%
  setNames('value') %>%
  st_set_dimensions(which = 'band', values = years, name = 'year')
```

```{r, fig.width = 12, fig.height=12}
library(sf)
```

```{r, fig.height=12, fig.width=12}
 st_read('~/Downloads/ArchaeGLOBE_Regions.shp') %>% st_transform(st_crs(anthromes)) %>% filter(Archaeo_RG == 'Southwestern USA') %>%
  st_crop(anthromes, .) %>%
  filter(between(year, 1700, 2000))%>%
  as_tibble() %>%
  filter(!is.na(value)) %>%
  left_join(anthrome_key, by = 'value') %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = class)) +
  facet_wrap(~year) + coord_quickmap() + theme_void() +scale_fill_manual(values = anthrome_class_color, na.value = 'transparent')
```


```{r}
st_read('~/Downloads/ArchaeGLOBE_Regions.shp') %>% st_transform(st_crs(anthromes)) %>% filter(Archaeo_RG %in% c('Turkey', 'Iraq', 'Syria, Cyprus, and the Levant')) %>%
  st_crop(anthromes, .) %>%
  filter(between(year, -10000, 0)) %>%
  as_tibble() %>%
  filter(!is.na(value)) %>%
  left_join(anthrome_key, by = 'value') %>%
  ggplot(aes(x, y)) +
  geom_tile(aes(fill = class)) +
  facet_wrap(~year) + coord_quickmap() + theme_void() +scale_fill_manual(values = anthrome_class_color, na.value = 'transparent')
```

```{r}
st_read('~/Downloads/ArchaeGLOBE_Regions.shp') %>% st_transform(st_crs(anthromes)) %>% filter(Archaeo_RG %in% c('Tunisia', 'Northern Algeria')) %>%
  st_crop(anthromes, .) %>%
  filter(between(year, 0, 500)) %>%
  as_tibble() %>%
  filter(!is.na(value)) %>%
  left_join(anthrome_key, by = 'value') %>%
  ggplot(aes(x, y)) +
  geom_tile(aes(fill = class)) +
  facet_wrap(~year) + coord_quickmap() + theme_void() +scale_fill_manual(values = anthrome_class_color, na.value = 'transparent') +
  theme(legend.position = 'bottom')
```


Calculate the cell areas and convert to km2.
```{r, cache=TRUE}
areas <- st_area(anthromes) %>% 
  st_set_crs(st_crs(anthromes)) %>%
  mutate(area = units::set_units(area, km^2)) %>%
  as_tibble()
```

Convert the raster into a tibble. Process each time step individualy to save RAM.
```{r, cache=TRUE}
prep_dat <- function(year.index) {
  anthromes %>%
  filter(year == year.index) %>%
  as_tibble() %>%
  filter(!is.na(value))
}

anthromes_dat <- map_dfr(years, prep_dat) %>%
  mutate_at(c('x', 'y'), round, digits = 5) %>%
  left_join(mutate_at(areas, c('x', 'y'), round, digits = 5), 
            by = c('x', 'y'))
```



```{r}
gc()
```

```{r}
anthromes_dat 
```


```{r}
anthromes_summary <- anthromes_dat %>%
  filter(year <= 2000, !(value %in% c(63, 70))) %>% # get rid of Ice, uninhabited 
  count(year, value, wt = area, name = 'area') %>%
  left_join(anthrome_key, by = 'value') %>%
  mutate(period = case_when(year %in% seq(-10000, 0, 1000) ~ 'Millennia',
           year %in% seq(100, 1700, 100) ~ 'Centuries',
           year %in% seq(1710, 2000, 10) ~ 'Decades'),
         period = factor(period, levels = c('Millennia', 'Centuries', 'Decades'))) 
```

```{r, fig.width=10, fig.height=5}
anthromes_summary%>%
 ggplot(aes(year, as.numeric(area))) +
  geom_line(aes(color = class), size = 1.1)+ 
 facet_wrap(~period, scales = 'free_x') +
  scale_color_manual(values = anthrome_class_color, name = 'Anthrome') +
    theme_bw() +
  labs(y = expression('Area ' (~km^2))) +
  theme(legend.position = 'bottom', panel.grid = element_blank())
```

```{r, fig.width=12, fig.height=5}
anthromes_summary%>%
 ggplot(aes(as.factor(year), as.numeric(area))) +
  geom_col(aes(fill = class, color = class))+ 
 facet_wrap(~period, scales = 'free_x') +
  scale_color_manual(values = anthrome_class_color) +
  scale_fill_manual(values = anthrome_class_color) +
      theme_classic() +
  labs(x = 'Year', y = expression('Area ' (~km^2))) +
  theme(legend.position = 'bottom')
```



```{r}

  
```


```{r}
ggplot(anthromes_dat, aes(x, y, fill = level)) +
  geom_raster() +
  coord_quickmap()+
  theme_void() +
  facet_wrap(~year) +
  scale_fill_manual(values = anthrome_level_color)
```

```{r}
ggplot() +
  geom_stars(data = anthromes) +
  facet_wrap(~year) +
  scale_fill_manual(values = key$class_color, na.value = 'transparent') +
  coord_equal() +
  theme_void()
```



```{r}
plot(anthromes[,,,1])
```


```{r}
anthromes_polys <- anthromes %>%
st_as_sf(as_points = FALSE, merge = TRUE, use_integer = TRUE, connect8 = TRUE) %>%
  st_make_valid()
```

```{r}
plot(anthromes_polys)
ggplot() +
  geom_stars(data = slice(anthromes, 'year', 1:4), downsample = 5) +
  facet_wrap(~year) +
  scale_fill_viridis_d(na.value = 'transparent') +
  coord_equal() +
  theme_void()
```


```{r}
test <- st_apply(anthromes, c('x', 'y', 'year'), function(x) st_as_sf(x, as_points = FALSE, merge = TRUE, use_integer = TRUE, connect8 = TRUE))

plot(anthromes[,,,1:6])
```

```{r}
test <- purrr::map_dfr(1:10, ~mutate(st_as_sf(anthromes[,,,.], as_points = FALSE, merge = TRUE, use_integer = TRUE, connect8 = TRUE), year = .)) %>%
  mutate(anthrome = as.factor(anthrome))

ggplot(test) +
  geom_sf(aes(fill = anthrome), color = NA) +
  scale_fill_viridis_d() +
  facet_wrap(~year) +
  theme_void()
```

