---
title: "Anthromes"
author: "Nick Gauthier"
date: "6/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stars)
library(tidyverse)
library(sf)
library(dggridR)

anthrome_key <- tibble(
  anthrome = c(11, 12, 21, 22, 23, 24, 31, 32, 33, 34, 41, 42, 43, 51, 
            52, 53, 54, 61, 62, 63, 70),
  class = factor(c('Urban', 'Mixed settlements', 'Rice villages', 'Irrigated villages', 
            'Rainfed villages', 'Pastoral villages', 'Residential irrigated croplands',
            'Residential rainfed croplands', 'Populated croplands', 'Remote croplands', 
            'Residential rangelands', 'Populated rangelands', 'Remote rangelands', 
            'Residential woodlands', 'Populated woodlands', 'Remote woodlands', 
            'Inhabited treeless & barren lands', 'Wild woodlands', 
            'Wild treeless and barren lands', 'Ice, uninhabited', 'NODATA'), 
            levels = c('Urban', 'Mixed settlements', 'Rice villages', 'Irrigated villages', 
            'Rainfed villages', 'Pastoral villages', 'Residential irrigated croplands',
            'Residential rainfed croplands', 'Populated croplands', 'Remote croplands', 
            'Residential rangelands', 'Populated rangelands', 'Remote rangelands', 
            'Residential woodlands', 'Populated woodlands', 'Remote woodlands', 
            'Inhabited treeless & barren lands', 'Wild woodlands', 
            'Wild treeless and barren lands', 'Ice, uninhabited', 'NODATA')),
  level = factor(c('Dense settlements', 'Dense settlements', 'Villages', 'Villages', 
            'Villages', 'Villages', 'Croplands', 'Croplands', 'Croplands', 'Croplands', 
            'Rangelands', 'Rangelands', 'Rangelands', 'Seminatural', 'Seminatural', 
            'Seminatural', 'Seminatural', 'Wildlands', 'Wildlands', 'Wildlands', 'NODATA'), 
            levels = c('Dense settlements', 'Villages', 'Croplands',
            'Rangelands', 'Seminatural', 'Wildlands', 'NODATA')),
  type = factor(c('Used', 'Used', 'Used', 'Used', 'Used', 'Used', 'Used', 'Used', 'Used', 
           'Used', 'Used', 'Used', 'Used', 'Seminatural', 'Seminatural','Seminatural', 
           'Seminatural', 'Wild', 'Wild', 'Wild', 'NODATA'), levels = c('Used', 'Seminatural', 'Wild', 'NODATA'))
)

anthrome_class_color <- c('#A80000', '#FF0000', '#0070FF', '#00A9E6', '#A900E6', 
                  '#FF73DF', '#00FFC5', '#E6E600', '#FFFF73', '#FFFFBE', 
                  '#E69800', '#FFD37F', '#FFEBAF', '#38A800', '#A5F57A', 
                  '#D3FFB2', '#B2B2B2', '#DAF2EA', '#E1E1E1', '#FAFFFF', NA) %>%
  setNames(anthrome_key$class)

anthrome_level_color <- c('Dense settlements' = '#CD6666', 'Villages' = '#AA66CD', 'Croplands' = '#FFFF00', 
                 'Rangelands' = '#FFAA00', 'Seminatural' = '#D3FFBE', 'Wildlands' = '#38A800', NODATA = NA)

anthrome_type_color <- c('Used' = '#EDCDCB', 'Seminatural' = '#FFFFFF', 'Wild' = '#CADAA9', NODATA = NA)

anthrome_class_color2 <- c('#A80000', '#FF0000', '#0070FF', '#00A9E6', '#A900E6', 
                  '#FF73DF', '#00FFC5', '#E6E600', '#FFFF73', '#FFFFBE', 
                  '#E69800', '#FFD37F', '#FFEBAF', '#38A800', '#A5F57A', 
                  '#D3FFB2', '#B2B2B2', '#DAF2EA', '#E1E1E1', '#FAFFFF', NA) %>%
  setNames(c(11, 12, 21, 22, 23, 24, 31, 32, 33, 34, 41, 42, 43, 51, 
            52, 53, 54, 61, 62, 63, 70))

time_steps <- c("10000BC", "9000BC", "8000BC", "7000BC", "6000BC", "5000BC", "4000BC", "3000BC", "2000BC", "1000BC", "0AD", "100AD", "200AD", "300AD", "400AD", "500AD", "600AD", "700AD", "800AD", "900AD", "1000AD", "1100AD", "1200AD", "1300AD", "1400AD", "1500AD", "1600AD",  "1700AD",  "1710AD",  "1720AD",  "1730AD",  "1740AD",  "1750AD",  "1760AD", "1770AD", "1780AD", "1790AD", "1800AD", "1810AD", "1820AD", "1830AD", "1840AD", "1850AD", "1860AD", "1870AD", "1880AD", "1890AD", "1900AD", "1910AD", "1920AD", "1930AD", "1940AD", "1950AD", "1960AD", "1970AD", "1980AD", "1990AD", "2000AD", "2001AD", "2002AD", "2003AD", "2004AD", "2005AD", "2006AD", "2007AD", "2008AD", "2009AD", "2010AD", "2011AD", "2012AD", "2013AD", "2014AD", "2015AD", "2016AD", "2017AD") 

time_steps_ordered <- factor(time_steps, levels = time_steps, ordered = TRUE)
 
recent_time_steps <-  c("2012AD",  "2013AD",  "2014AD",  "2015AD",  "2016AD",  "2017AD")
 
 time_steps_millennia <- c("10000BC", "9000BC", "8000BC", "7000BC", "6000BC", "5000BC", "4000BC", "3000BC", "2000BC", "1000BC", "0AD", "1000AD", "2000AD")
 
 time_steps_centuries <- c("0AD", "100AD", "200AD", "300AD", "400AD", "500AD", "600AD", "700AD", "800AD", "900AD", "1000AD", "1100AD", "1200AD", "1300AD", "1400AD", "1500AD", "1600AD",  "1700AD",  "1800AD",  "1900AD", "2000AD", "2010AD")
 
 time_steps_decades <- c("1700AD", "1710AD",  "1720AD",  "1730AD",  "1740AD",  "1750AD",  "1760AD", "1770AD", "1780AD", "1790AD", "1800AD", "1810AD", "1820AD", "1830AD", "1840AD", "1850AD", "1860AD", "1870AD", "1880AD", "1890AD", "1900AD", "1910AD", "1920AD", "1930AD", "1940AD", "1950AD", "1960AD", "1970AD", "1980AD", "1990AD", "2000AD", "2010AD")
 
 years <- c(seq(-10000, -1000, 1000), 1,
           seq(100, 1700, 100),
           seq(1710, 2000, 10),
           seq(2001, 2017, 1))
 
time_key <- tibble(time_step = time_steps_ordered, year = years)

period_key <- tibble(time_step = time_steps_ordered) %>%
  mutate(millennia = time_step %in% time_steps_millennia,
         centuries = time_step %in% time_steps_centuries,
         decades = time_step %in% time_steps_decades)

biome_key <- tibble(biome_value = 1:15,
                       biome = c('Tropical rainforest', 'Tropical woodlands', 'Warm mixed forest', 'Temperate mixed forest', 'Temperate deciduous forest', 'Boreal forest', 'Temperate coniferous forest', 'Cool conifer forest', 'Open grasslands, savanna', 'Cool grasslands, steppe', 'Closed shrubland', 'Open shrubland',	'Tundra',	'Hot desert', 'Ice, snow')) %>%
  # combine biomes 2 + 3 and 5 + 6
  mutate(biome = if_else(biome_value %in% c(2,3), 'Tropical mixed woodlands', 
                         if_else(biome_value %in% c(6, 7), 'Northern coniferous forest',
                         biome)),
         # define levels so plots have correct order
         biome = factor(biome, levels = c('Tropical rainforest', 'Tropical mixed woodlands', 'Temperate mixed forest', 'Temperate deciduous forest', 'Northern coniferous forest', 'Cool conifer forest', 'Open grasslands, savanna', 'Cool grasslands, steppe', 'Closed shrubland', 'Open shrubland',	'Tundra',	'Hot desert', 'Ice, snow')))
```

# Setup

Import preprocessed data.

```{r}
an12_dgg_inputs <- read_sf('an12_dgg_inputs.shp')  %>% st_set_crs(4326)
an12_dgg <- read_csv('an12_dgg.csv')

total_land_area <- sum(an12_dgg_inputs$land_area)
```



# Summary
```{r}
anthromes_summary <- an12_dgg %>% 
  left_join(st_drop_geometry(an12_dgg_inputs), by = 'id') %>%
  select(-pot_veg, -pot_vill) %>%
  pivot_longer(-c(id, land_area), names_to = 'time_step', values_to = 'anthrome') %>%
  mutate(anthrome= as.factor(anthrome)) %>%
  count(time_step, anthrome, wt = land_area, name = 'land_area', .drop = FALSE) %>%
  mutate(percent_land_area = land_area / total_land_area,
         anthrome = as.numeric(as.character(anthrome))) %>%
  left_join(anthrome_key, by = 'anthrome') %>%
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% seq(1710, 2000, 10) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  filter(year <= 2000) %>% # this should be redundant
  arrange(year, anthrome) %>%
  select(time_step, anthrome, class, percent_land_area, period, year)
```

```{r}
write_csv(anthromes_summary, 'an12_dgg_summary.csv')
```

```{r}
hyde_pop <- read_csv('hyde_dgg_time.csv') %>%
  filter(id %in% an12_dgg$id) %>%
  group_by(time_step) %>%
  summarise(population = sum(popc)) %>%
  left_join(time_key) %>%
  select(year, population) %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% seq(1710, 2000, 10) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  filter(year <= 2000) %>%
  mutate(pop_percent = population / max(population))
```


```{r, fig.width=11, fig.height=5}
anthromes_summary %>%
 ggplot(aes(as.factor(year), percent_land_area)) +
#  geom_area(aes(fill = class, color = class), position = 'stack') +
#  geom_col(aes(fill = class), color = 'lightgrey', size = .2)+
  geom_col(aes(fill = class, color = class), size = 1)+
  geom_hline(yintercept = c(.25, .50, .75), linetype = 2, alpha = .3) +
  geom_line(data = hyde_pop, aes(x = as.factor(year), y = pop_percent), color = 'maroon', linetype = 1, group = 1, size = 1.2) + 
  #geom_label(aes(label = label), data = tibble(year = 20010,  percent_land_area = 1, label = 'Population', period = factor('Decades', c('Millennia', 'Centuries', 'Decades')))) +
 facet_grid(~period, scales = 'free_x', space = 'free') +
  scale_color_manual(values = anthrome_class_color, name = 'Anthrome') +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome') +
      theme_classic() +
  scale_y_continuous(labels = scales::percent, expand = c(0,0.02)) +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1700, 1800, 1900, 2000),
                   labels = c('10000 ʙᴄᴇ', '5000 ʙᴄᴇ', '1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1700 ᴄᴇ', '1800 ᴄᴇ', '1900 ᴄᴇ', '2000 ᴄᴇ')) +
  labs(x = 'Year', y = 'Percent land surface') +
  theme(legend.position = 'bottom', plot.margin = margin(.2, .2,.2, r = .5, unit = 'cm'))

ggsave('anthrome_areas_population.png', width = 11, height = 5)
```

## Biome summary
```{r}
biome_summary <- an12_dgg %>% 
  left_join(st_drop_geometry(an12_dgg_inputs), by = 'id') %>%
  select(-pot_vill) %>%
  pivot_longer(-c(id, land_area, pot_veg), names_to = 'time_step', values_to = 'anthrome') %>%
    mutate(anthrome= as.factor(anthrome), pot_veg = as.factor(pot_veg)) %>%
  count(time_step, anthrome, pot_veg, wt = land_area, name = 'land_area', .drop = FALSE) %>%
  mutate(percent_land_area = land_area / total_land_area,
                  anthrome = as.numeric(as.character(anthrome)),
         pot_veg = as.numeric(as.character(pot_veg))) %>%
  left_join(anthrome_key, by = 'anthrome') %>%
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% seq(1710, 2000, 10) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  filter(year <= 2000) %>% # this should be redundant
  arrange(year, pot_veg, anthrome) %>%
    left_join(biome_key, by = c('pot_veg' = 'biome_value')) %>%
  select(time_step, pot_veg, biome, anthrome, class, percent_land_area, period, year)

write_csv(biome_summary, 'an12_dgg_summary_biomes.csv')
```


```{r, fig.height = 12, fig.width = 11}
biome_summary %>%
  filter(biome %in% c('Tropical rainforest', 'Tropical mixed woodlands', 'Temperate mixed forest', 'Temperate deciduous forest', 'Northern coniferous forest', 'Cool conifer forest')) %>%
 # mutate(pretty_biomes = str_wrap(biomes)) %>%
 ggplot(aes(as.factor(year), percent_land_area)) +
  geom_col(aes(fill = class), color = 'lightgrey', size = .1)+ 
 #facet_grid(biome~period, scales = 'free', space = 'free') +
   facet_grid(biome~period, scales = 'free', space = 'free_x') +
  scale_color_manual(values = anthrome_class_color, name = 'Anthrome') +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome') +
      theme_classic() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1700, 1800, 1900, 2000),
                   labels = c('10000 ʙᴄᴇ', '5000 ʙᴄᴇ', '1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1700 ᴄᴇ', '1800 ᴄᴇ', '1900 ᴄᴇ', '2000 ᴄᴇ')) +
  labs(x = 'Year', y = expression('Percent land surface'))

ggsave('anthromes_summary_forested_biomes.png', height = 12, width = 11)
```


```{r, fig.height = 12, fig.width = 11}
biome_summary %>%
  filter(!(biome %in% c('Tropical rainforest', 'Tropical mixed woodlands', 'Temperate mixed forest', 'Temperate deciduous forest', 'Northern coniferous forest', 'Cool conifer forest'))) %>%
 # mutate(pretty_biomes = str_wrap(biomes)) %>%
 ggplot(aes(as.factor(year), percent_land_area)) +
  geom_col(aes(fill = class), color = 'lightgrey', size = .1)+ 
 #facet_grid(biome~period, scales = 'free', space = 'free') +
   facet_grid(biome~period, scales = 'free', space = 'free_x') +
  scale_color_manual(values = anthrome_class_color, name = 'Anthrome') +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome') +
      theme_classic() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = scales::pretty_breaks(3)) +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1700, 1800, 1900, 2000),
                   labels = c('10000 ʙᴄᴇ', '5000 ʙᴄᴇ', '1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1700 ᴄᴇ', '1800 ᴄᴇ', '1900 ᴄᴇ', '2000 ᴄᴇ')) +
  labs(x = 'Year', y = expression('Percent land surface'))

ggsave('anthromes_summary_nonforest_biomes.png', height = 12, width = 11)
```

## Region summary

```{r}
library(exactextractr)
regions_dgg <- raster::raster('../simple_regions.tif') %>% plot
  exact_extract(an12_dgg_inputs, 'mode')
  
region_key <- tibble(region = 1:8, region_name = c('Eurasia', 'Latin America and Caribbean', 'Near East', 'Africa', 'Asia', 'Europe', 'North America', 'Oceania'))

region_summary <- an12_dgg %>% 
  mutate(region = regions_dgg, land_area = an12_dgg_inputs$land_area) %>%
  pivot_longer(-c(id, land_area, region), names_to = 'time_step', values_to = 'anthrome') %>%
    mutate(anthrome= as.factor(anthrome), region = as.factor(region)) %>%
  count(time_step, anthrome, region, wt = land_area, name = 'land_area', .drop = FALSE) %>%
  mutate(percent_land_area = land_area / total_land_area,
                  anthrome = as.numeric(as.character(anthrome)),
         region = as.numeric(as.character(region))) %>%
  left_join(anthrome_key, by = 'anthrome') %>%
  left_join(time_key, by = 'time_step') %>%
  mutate(period = case_when(year %in% c(seq(-10000, -1000, 1000), 1) ~ 'Millennia',
                            year %in% seq(100, 1700, 100) ~ 'Centuries',
                            year %in% seq(1710, 2000, 10) ~ 'Decades'),
         period = factor(period, c('Millennia', 'Centuries', 'Decades'))) %>%
  filter(year <= 2000) %>% # this should be redundant
  arrange(year, region, anthrome) %>%
    left_join(region_key) %>%
  select(time_step, region_name, anthrome, class, percent_land_area, period, year)

write_csv(region_summary, 'an12_dgg_summary_region.csv')
```


```{r, fig.height = 12, fig.width = 11}
region_summary %>% 
 # mutate(pretty_biomes = str_wrap(biomes)) %>%
 ggplot(aes(as.factor(year), percent_land_area)) +
  geom_col(aes(fill = class), color = 'lightgrey', size = .1)+ 
 #facet_grid(biome~period, scales = 'free', space = 'free') +
   facet_grid(region_name~period, scales = 'free', space = 'free_x') +
  scale_color_manual(values = anthrome_class_color, name = 'Anthrome') +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome') +
      theme_classic() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_x_discrete(breaks = c(-10000, -5000, 1, 500, 1000, 1700, 1800, 1900, 2000),
                   labels = c('10000 ʙᴄᴇ', '5000 ʙᴄᴇ', '1 ᴄᴇ', '500 ᴄᴇ', '1000 ᴄᴇ', '1700 ᴄᴇ', '1800 ᴄᴇ', '1900 ᴄᴇ', '2000 ᴄᴇ')) +
  labs(x = 'Year', y = expression('Percent land surface'))

ggsave('anthromes_summary_region.png', height = 12, width = 11)
```

# Onsets
```{r fig.width = 10, fig.height=12}
suppressWarnings(
  onset_seminatural <- an12_dgg %>%
    pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
  group_by(id) %>%
    filter(anthrome < 61, .preserve = TRUE) %>%
    left_join(time_key) %>%
  summarise(onset = min(year)))


suppressWarnings(
  onset_used <- an12_dgg %>%
    pivot_longer(-id, names_to = 'time_step', values_to = 'anthrome') %>%
  group_by(id) %>%
    filter(anthrome < 51, .preserve = TRUE) %>%
    left_join(time_key) %>%
  summarise(onset = min(year)))

bind_rows(onset_seminatural, onset_used, .id = 'type') %>%
  mutate(type = if_else(type == 1, 'Onset of Seminatural Anthromes', 'Onset of Used Anthromes')) %>%
  left_join(an12_dgg_inputs) %>%
  left_join(time_key, by = c('onset' = 'year')) %>%
  
ggplot() +
  geom_sf(aes(fill = onset, geometry = geometry), color = NA)+
  scale_fill_viridis_c(option = 'A', na.value = 'lightgrey') +
  facet_wrap(~type, nrow = 2) 
```

DGG
```{r}
# construct the DGG
dggs <- dgconstruct(res=12)

#save the DGG
dgearthgrid(dggs, frame = TRUE, wrapcells = FALSE, savegrid =  "./l12_ISEA3H_dgg.shp")

dgg <- dgconstruct(res = 12) %>%
  dgearthgrid(frame = TRUE, wrapcells = FALSE, savegrid = 'dgg_l12.shp')


grid <- dgconstruct(res = 7) %>%
  dgearthgrid(frame = FALSE, wrapcells = FALSE) %>%
  st_as_sf() %>%
  mutate(id = 1:n()) %>%
  st_wrap_dateline(options = c("WRAPDATELINE=YES", "DATELINEOFFSET=30")) %>%
  .[land_mask, ]

 #%>% st_set_crs('+proj=isea')
plot(grid)
```

```{r}
dgg12 <- read_sf('data/raw_data/l12_ISEAH_dgg.shp/l12_ISEA3H_dgg.shp')

dgg12 <- st_set_crs(dgg12 , st_crs(anthromes))
```

# Regression

```{r}
test_dat <- an12_dgg %>%
  pivot_longer(-id, names_to = 'time', values_to = 'anthrome') %>%
  left_join(anthrome_key) %>%
  dplyr::select(-anthrome, -level, -type) %>%
  pivot_wider(names_from = time, values_from = class) %>%
  mutate(hfp_max = hfp_dgg$max) %>%
  filter(!is.na(hfp_max)) # shouldn't have to do this last step!

mod1 <-
mille
AIC(mod1)

calc_aic <- function(predictor){
  as.f
 
}

test_aic <- c(`10000BC`, `9000BC`, `8000BC`, `7000BC`, `6000BC`, `5000BC`, `4000BC`, `3000BC`, `2000BC`, `1000BC`, `0AD`, `1000AD`, `2000AD`) %>%
  map_dbl(calc_aic)


c(lm(hfp_max ~ `2000AD`, data = test_dat) %>% AIC,
    lm(hfp_max ~ `1900AD`, data = test_dat) %>% AIC,
      lm(hfp_max ~ `1800AD`, data = test_dat) %>% AIC,
        lm(hfp_max ~ `1700AD`, data = test_dat) %>% AIC,
          lm(hfp_max ~ `1600AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `1500AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `1400AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `1300AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `1200AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `1100AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `1000AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `900AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `800AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `700AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `600AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `500AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `400AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `300AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `200AD`, data = test_dat) %>% AIC,
           lm(hfp_max ~ `100AD`, data = test_dat) %>% AIC,
  lm(hfp_max ~ `0AD`, data = test_dat) %>% AIC,
             lm(hfp_max ~ `5000BC`, data = test_dat) %>% AIC,
  lm(hfp_max ~ `10000BC`, data = test_dat) %>% AIC) %>% plot
```

```{r}
library(glmnet)
test_mat <- test_dat %>%
  dplyr::select(`10000BC`:`2000AD`) %>%
  data.matrix()
test_mod <- cv.glmnet(test_mat, pull(test_dat, hfp_max), family = 'gaussian', standardize = FALSE)
test_mod
plot(test_mod)

coef(test_mod, s= "lambda.1se")

```



# Treemap

```{r, fig.width = 10, fig.height=4.5}
library(treemapify)

anthromes_summary %>%
  filter(year %in% c(1, 1000, 2000)) %>%
  mutate(year = paste(year, 'CE')) %>%
  ggplot(aes(area = as.numeric(area), fill  = class, label = class, subgroup = level)) +
  geom_treemap() +
  geom_treemap_subgroup_border(color = 'black') +
    facet_wrap(~year) +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome')  +
  theme(legend.position  = 'bottom') +
  geom_treemap_subgroup_text(reflow = TRUE, fontface = 'italic', alpha = .8)

ggsave('treeplot1.png', width = 10, height = 4.5)
```

```{r, fig.height=10, fig.width = 10}
anthromes_summary %>%
  filter(year %in% c(1700, 1800, 1900, 2000)) %>%
  mutate(year = paste(year, 'CE')) %>%
  ggplot(aes(area = as.numeric(area), fill  = class, label = class, subgroup = level)) +
  geom_treemap() +
  geom_treemap_subgroup_border(color = 'black') +
    facet_wrap(~year) +
  scale_fill_manual(values = anthrome_class_color, name = 'Anthrome')  +
  theme(legend.position  = 'bottom') +
  geom_treemap_subgroup_text(reflow = TRUE, fontface = 'italic', alpha = .8)

ggsave('treeplot2.png', width = 10, height = 10)
```

# Alluvial plots

```{r}
library(ggalluvial)
test <- anthromes_dat %>% 
  filter(year %in% c(0, 500, 1000, 1500, 2000)) %>%
  left_join(anthrome_key)
  
ggplot(test, aes(x = as.factor(year), stratum = level, fill = level, label = level, alluvium = interaction(x,y), y = as.numeric(area))) +
    geom_flow() +
  geom_stratum(alpha = .5) +
  scale_fill_manual(values = anthrome_level_color, name = 'Anthrome')  +
  theme(legend.position  = 'bottom') +
  geom_text(stat = 'stratum', size = 3) +
  theme_minimal()
```


# Correlograms

```{r}
library(corrplot)
periods <- anthromes_summary %>%
  group_by(period) %>%
  nest

periods %>%
  mutate(data = map(data, ~  select(., year, area, class) %>%
  pivot_wider(names_from = class, values_from = area) %>%
  select(-year) %>%
    cor)) %>%
  pull(data) %>%
  map(~ corrplot(., method = 'color', type = 'lower'))


cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}

test2%>%
  cor %>%
  corrplot(method = 'color', type = 'lower', order = 'hclust', p.mat = cor.mtest(test2), sig.level = 0.01, insig = 'blank')
```

