---
title: "Contemporary Variables"
author: "Nick Gauthier"
date: "8/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(exactextractr)
library(tidyverse)
library(sf)
```

Processing contemporary variables for comparison to Anthromes data

Import anthromes dgg data
```{r}
an12_dgg_inputs <- read_sf('an12_dgg_inputs.shp') %>% st_set_crs(4326)
```


```{r}
nmh <- raster('data/raw_data/WCMC_natural_modified_habitat_screening_layer/natural_modified_habitat_screening_layer.tif')
# two different ways to get nmh, modal and proportional
nmh_extract <- exact_extract(nmh, an12_dgg_inputs, fun = 'mode')
nmh_tibble <- exact_extract(nmh, an12_dgg_inputs, function(value, frac) tapply(frac, value, sum) / sum(frac)) %>% 
  map(~{if(length(.) > 0})
  map(~{if(length(.) == 0) c(`1` = NA, `2` = NA, `3` = NA, `4` = NA) else .}) %>% 
  map_dfr(as.list) %>%
      replace_na(list(`1` = 0, `2` = 0, `3` = 0, `4` = 0)) %>% # turn na's into zeros
            transmute(nmh_4 = `4`, nmh_34 = `3` + `4`)
```

```{r}
dgg <- an12_dgg_inputs %>%
  mutate(nmh = as.factor(nmh_extract))
```

```{r}
id_key <- read_sf('../an12_dgg_cells.shp') %>%
  filter(DGG_status == 3) %>% dplyr::select(L1_ID, ANL12_ID) %>%
  st_drop_geometry()

tgc <- read_csv('data/raw_data/three_conditions_v4_rep_data.csv') %>% 
  dplyr::select(l1_id, biome, `@3_cond_v4`, hfp_max, pa_km2, kba_km2, ind_cnt, v_rich, v_thr) %>%
  rename(olson_biome = biome)
```


```{r}
contemp_vars <- dgg %>%
  select(-pot_veg, -pot_vill)  %>%
  left_join(id_key, by = c('id' = 'ANL12_ID')) %>% 
  left_join(tgc, by = c('L1_ID' = 'l1_id')) 
```


```{r}
sum(tgc$l1_id %in% contemp_vars$L1_ID)
sum(contemp_vars$L1_ID %in% tgc$l1_id)
```

1,434,246 -> tgc
1,429,024 -> reduced grid
1,424,807 -> overlap


```{r}
write_sf(contemp_vars, 'contemp_vars.shp')

contemp_vars <- read_sf('contemp_vars.shp')

bind_cols(contemp_vars, nmh_tibble) %>% 
  write_sf('contemp_vars.shp')
```
Saving to shapefile messes with some of the variables names so this is necessary. shouldn't be though . . .
```{r}
contemp_vars <- read_sf('contemp_vars.shp') %>%
  mutate(pa = pa_km2 >= land_ar, ind = ind_cnt >= land_ar, kba = kba_km2 >= land_ar, pa50 = pa_km2 >= (0.5 * land_ar), ind50 = ind_cnt >= (0.5 * land_ar), kba50 = kba_km2 >= (0.5 * land_ar), v_rich = round(v_rich), v_thr = round(v_thr), hfp_max = round(hfp_max))
```
saving data out
```{r}
contemp_vars %>% select(id, nmh, nmh_4, nmh_34) %>% rename(nmh_mode = nmh, nmh_4_frac = nmh_4, nmh_34_frac = nmh_34) %>%
  mutate(nmh_3_frac = nmh_34_frac - nmh_4_frac) %>%
  write_csv('nmh_natural_fraction.csv')
```



Check that everything looks OK.

```{r}
contemp_vars %>%
st_crop(st_bbox(c(xmin = 30, xmax = 40, ymin = 30, ymax = 40))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = hfp_max), color = NA) +
  scale_fill_viridis_c() +
  ggtitle('Human footprint (max)') +
  coord_sf(crs = st_crs("+proj=eck4"))
contemp_vars %>%
st_crop(st_bbox(c(xmin = 30, xmax = 40, ymin = 30, ymax = 40))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = max), color = NA) +
  scale_fill_viridis_c() +
  ggtitle('Human footprint (max)') +
  coord_sf(crs = st_crs("+proj=eck4"))
contemp_vars %>%
st_crop(st_bbox(c(xmin = 30, xmax = 40, ymin = 30, ymax = 40))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = v_thr), color = NA) +
  scale_fill_viridis_c() +
  coord_sf(crs = st_crs("+proj=eck4"))
contemp_vars %>%
st_crop(st_bbox(c(xmin = 30, xmax = 40, ymin = 30, ymax = 40))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = v_rich), color = NA) +
  scale_fill_viridis_c() +
  coord_sf(crs = st_crs("+proj=eck4"))
contemp_vars %>%
st_crop(st_bbox(c(xmin = 10, xmax = 40, ymin = 30, ymax = 50))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = kba_km2), color = NA) +
  scale_fill_viridis_c() +
  coord_sf(crs = st_crs("+proj=eck4"))

bind_cols(contemp_vars, nmh_tibble) %>%
  st_crop(st_bbox(c(xmin = 10, xmax = 40, ymin = 30, ymax = 50))) %>% # comment out for whole world
  ggplot() +
  geom_sf(aes(fill = nmh_34 > .2), color = NA) +
  scale_fill_viridis_d() +
  coord_sf(crs = st_crs("+proj=eck4"))
```



